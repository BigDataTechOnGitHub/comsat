<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/Organization">
<head>
	<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
<head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
        <title>Parallel Universe</title>
        <meta name="description" content="">
        <meta name="format-detection" content="telephone=no">
        <meta name="viewport" content="width=1100">
        <script type="text/javascript" src="//use.typekit.net/pfn0abv.js"></script>
        <script type="text/javascript">try{Typekit.load();}catch(e){}</script>
        <link href='http://fonts.googleapis.com/css?family=Arimo:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" type="text/css" href="/comsat/css/screen.css">
        <script src="/comsat/js/vendor/modernizr-2.6.2.min.js"></script>

        <script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
        <script>window.jQuery || document.write('<script src="/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
        <script src="/comsat/js/plugins.js"></script>
        <script src="/comsat/js/main.js"></script>

        <script>
            var _gaq=[['_setAccount','UA-25007319-2'],['_trackPageview']];
            (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
            g.src='//www.google-analytics.com/ga.js';
            s.parentNode.insertBefore(g,s)}(document,'script'));
        </script>

        <meta name="twitter:site" content="@puniverseco"> 

	<!-- Twitter -->
	<meta name="twitter:card" content="summary"> 
	<meta name="twitter:title" content="Comsat"> 
	<meta name="twitter:description" content="Comsat integrates lightweight threads and actors with the JVM web stack."> 

	<!-- OpenGraph -->
	<meta property="og:site_name" content="Parallel Universe">
	<meta property="og:type" content="website">
	<meta property="og:title" content="Comsat">
	<meta property="og:description" content="Comsat integrates lightweight threads and actors with the JVM web stack.">
	<meta property="og:url" content="/comsat/">
	<meta property="og:image" content="http://www.gravatar.com/avatar/d942a0d3bac0a907acfb7d78c8846d1a?s=200">

    <!--[if lt IE 9]>
        <script src="js/vendor/html5shiv.js"></script>
    <![endif]-->
     <!--[if lt IE 8]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->
</head>
</head>
<body class="fixed-documentation">
	ֿ
<header>
    <div class="container">
        <a href="http://paralleluniverse.co" id="logo">Parallel Universe</a>
        <ul id="nav">
            <li class="sub">
                <a>Products</a>
                <ul>
                    <li class="li1"><a href="http://paralleluniverse.co/comsat/">Comsat</a></li>
                    <li class="li2"><a href="http://paralleluniverse.co/quasar/">Quasar</a></li>
                    <li class="li3"><a href="http://paralleluniverse.co/spacebase/">Spacebase</a></li>
                    <li class="li4"><a href="http://paralleluniverse.co/galaxy/">Galaxy</a></li>
                </ul>
            </li>
            <li><a href="http://paralleluniverse.co/support/">Support</a></li>
            <li><a href="http://docs.paralleluniverse.co">Documentation</a></li>
            <li><a href="http://paralleluniverse.co/about/">Company</a></li>
            <li><a href="http://blog.paralleluniverse.co">Blog</a></li>
        </ul>
    </div>
</header>
 

	<section id="main">
		<div class="container">
			<div id="docs-cont" class="clearfix">
				<div class="sidebar">
					<ul id="docs-sidemenu">
<li class="li1">
<a href="#overview">Overview</a><ul><li>
<a href="#news" class="cat-link">News</a><ul>
<li><a href="#february-2016">10 February, 2016</a></li>
<li><a href="#august-2015">28 August, 2015</a></li>
<li><a href="#july-1-2015">July 1, 2015</a></li>
<li><a href="#december-23-2014">December 23, 2014</a></li>
<li><a href="#july-23-2014">July 23, 2014</a></li>
<li><a href="#january-22-2014">January 22, 2014</a></li>
</ul>
</li></ul>
</li>
<li class="li1">
<a href="#getting-started">Getting Started</a><ul>
<li><ul>
<li><a href="#system-requirements">System requirements</a></li>
<li><a href="#maven">Using Comsat with Maven and Gradle</a></li>
</ul></li>
<li>
<a href="#examples" class="cat-link">Examples</a><ul>
<li><a href="#enabling-comsat">Enabling Comsat</a></li>
<li><a href="#build">Building Comsat</a></li>
</ul>
</li>
</ul>
</li>
<li class="li1">
<a href="#user-manual">User Manual</a><ul>
<li>
<a href="#comsat-integration" class="cat-link">Comsat Integration</a><ul>
<li><a href="#servlets">Servlets</a></li>
<li><a href="#rest-services">REST Services</a></li>
<li><a href="#clojure-ring">Clojure Ring</a></li>
<li><a href="#clojure-http-kit-client">Clojure HTTP Kit Client</a></li>
<li><a href="#http-clients">HTTP Clients</a></li>
<li><a href="#db-access">DB Access</a></li>
<li><a href="#dropwizard">Dropwizard</a></li>
<li><a href="#spring">Spring</a></li>
</ul>
</li>
<li>
<a href="#web-actors" class="cat-link">Web Actors</a><ul>
<li><a href="#netty-deployment">Netty deployment</a></li>
<li><a href="#undertow-deployment">Undertow deployment</a></li>
<li><a href="#servlet-deployment">Servlet deployment</a></li>
<li><a href="#basic-operation">Basic Operation</a></li>
<li><a href="#http-rest-services">HTTP (REST Services)</a></li>
<li><a href="#sse">SSE</a></li>
<li><a href="#websockets">WebSockets</a></li>
</ul>
</li>
</ul>
</li>
</ul>
				</div>

				<div class="main">
					<div class="doc-text">
						<h1 id="overview">Overview</h1>

<p><span class="caps">COMSAT</span> (or Comsat) is a set of open source libraries that integrate <a href="http://puniverse.github.io/quasar/">Quasar</a> with various web or enterprise technologies (like <span class="caps">HTTP</span> services and database access). With Comsat, you can write web applications that are scalable and performing and, at the same time, are simple to code and&nbsp;maintain.</p>

<p>Comsat is not a web framework. In fact, it does not add new APIs at all (with one exception, Web Actors, mentioned later). It provides implementation to popular (and often, standard) APIs like Servlet, <span class="caps">JAX</span>-<span class="caps">RS</span>, and <span class="caps">JDBC</span>, that can be used efficiently within Quasar&nbsp;fibers.</p>

<p>Comsat does provide one new <span class="caps">API</span> that you may choose to use: Web Actors. Web actors let you define a Quasar actor that receives and responds to <span class="caps">HTTP</span> requests and web socket messages. The Web Actors <span class="caps">API</span> is rather minimal, and is intended to do one job and do it well: simplify two-way communication between your server and the&nbsp;client.</p>

<h2 id="news">News</h2>

<h3 id="february-2016">10 February,&nbsp;2016</h3>

<p><span class="caps">COMSAT</span> <a href="https://github.com/puniverse/comsat/releases/tag/v0.6.0"><span class="caps">0.6.0</span></a> has been&nbsp;released.</p>

<h3 id="august-2015">28 August,&nbsp;2015</h3>

<p><span class="caps">COMSAT</span> <a href="https://github.com/puniverse/comsat/releases/tag/v0.5.0"><span class="caps">0.5.0</span></a> has been&nbsp;released.</p>

<h3 id="july-1-2015">July 1,&nbsp;2015</h3>

<p><span class="caps">COMSAT</span> <a href="https://github.com/puniverse/comsat/releases/tag/v0.4.0"><span class="caps">0.4.0</span></a> has been&nbsp;released.</p>

<h3 id="december-23-2014">December 23,&nbsp;2014</h3>

<p><span class="caps">COMSAT</span> <a href="https://github.com/puniverse/comsat/releases/tag/v0.3.0"><span class="caps">0.3.0</span></a> has been&nbsp;released.</p>

<h3 id="july-23-2014">July 23,&nbsp;2014</h3>

<p><span class="caps">COMSAT</span> <a href="https://github.com/puniverse/comsat/releases/tag/v0.2.0"><span class="caps">0.2.0</span></a> has been&nbsp;released.</p>

<h3 id="january-22-2014">January 22,&nbsp;2014</h3>

<p><span class="caps">COMSAT</span> <a href="https://github.com/puniverse/comsat/releases/tag/v0.1.0"><span class="caps">0.1.0</span></a> has been&nbsp;released.</p>

<h1 id="getting-started">Getting&nbsp;Started</h1>

<h3 id="system-requirements">System&nbsp;requirements</h3>

<p>Java 7 is required to use&nbsp;<span class="caps">COMSAT.</span></p>

<h3 id="maven">Using Comsat with <a href="https://maven.apache.org">Maven</a> and <a href="http://www.gradle.org">Gradle</a></h3>

<p>First, you need the <code>quasar-core</code> dependency. With&nbsp;Maven:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="nt">&lt;dependency&gt;</span>
</span><span id="line-2">    <span class="nt">&lt;groupId&gt;</span>co.paralleluniverse<span class="nt">&lt;/groupId&gt;</span>
</span><span id="line-3">    <span class="nt">&lt;artifactId&gt;</span>quasar-core<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="line-4">    <span class="nt">&lt;version&gt;</span>0.7.2<span class="nt">&lt;/version&gt;</span>
</span><span id="line-5"><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></div>
<p>or, for&nbsp;<span class="caps">JDK8</span>:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="nt">&lt;dependency&gt;</span>
</span><span id="line-2">    <span class="nt">&lt;groupId&gt;</span>co.paralleluniverse<span class="nt">&lt;/groupId&gt;</span>
</span><span id="line-3">    <span class="nt">&lt;artifactId&gt;</span>quasar-core<span class="nt">&lt;/artifactId&gt;</span>
</span><span id="line-4">    <span class="nt">&lt;version&gt;</span>0.7.2<span class="nt">&lt;/version&gt;</span>
</span><span id="line-5">    <span class="nt">&lt;classifier&gt;</span>jdk8<span class="nt">&lt;/classifier&gt;</span>
</span><span id="line-6"><span class="nt">&lt;/dependency&gt;</span>
</span></code></pre></div>
<p>The corresponding Gradle dependencies are respectively <code>co.paralleluniverse:quasar-core:0.7.2</code> or, for <span class="caps">JDK8</span>,&nbsp;<code>co.paralleluniverse:quasar-core:0.7.2@jdk8</code>.</p>

<p>Then add the following Maven/Gradle&nbsp;dependencies:</p>

<table>
  <thead>
    <tr>
      <th>Feature</th>
      <th>Artifact</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Servlet integration for defining fiber-per-request servlets.</td>
      <td><code>co.paralleluniverse:comsat-servlet:0.6.0</code></td>
    </tr>
    <tr>
      <td>A fiber-blocking Clojure <a href="https://github.com/ring-clojure/ring">Ring</a> adapter based on Jetty <span class="caps">9.3.</span></td>
      <td><code>co.paralleluniverse:comsat-ring-jetty9:0.6.0</code></td>
    </tr>
    <tr>
      <td><a href="http://www.http-kit.org/client.html"><span class="caps">HTTP</span> Kit</a>-based fiber-blocking <span class="caps">HTTP</span> client.</td>
      <td><code>co.paralleluniverse:comsat-httpkit:0.6.0</code></td>
    </tr>
    <tr>
      <td><a href="https://jersey.java.net/">Jersey server</a> integration for defining <span class="caps">REST</span> services.</td>
      <td><code>co.paralleluniverse:comsat-jersey-server:0.6.0</code></td>
    </tr>
    <tr>
      <td><a href="http://dropwizard.io/">Dropwizard</a> integration including Jersey, ApacheHttpClient and <span class="caps">JDBI.</span></td>
      <td><code>co.paralleluniverse:comsat-dropwizard:0.6.0</code></td>
    </tr>
    <tr>
      <td><a href="http://projects.spring.io/spring-framework/">Spring Framework</a> Web <span class="caps">MVC</span> fiber-blocking controller methods integration.</td>
      <td><code>co.paralleluniverse:comsat-spring-webmvc:0.6.0</code></td>
    </tr>
    <tr>
      <td><a href="http://projects.spring.io/spring-boot/">Spring Boot</a> auto-configuration support for Web <span class="caps">MVC</span> controllers.</td>
      <td><code>co.paralleluniverse:comsat-spring-boot:0.6.0</code></td>
    </tr>
    <tr>
      <td><a href="http://projects.spring.io/spring-security/">Spring Security</a> configuration support for fibers.</td>
      <td><code>co.paralleluniverse:comsat-spring-security:0.6.0</code></td>
    </tr>
    <tr>
      <td><a href="https://jersey.java.net/documentation/latest/client.html"><span class="caps">JAX</span>-<span class="caps">RS</span> client</a> integration for <span class="caps">HTTP</span> calls with fibers.</td>
      <td><code>co.paralleluniverse:comsat-jax-rs-client:0.6.0</code></td>
    </tr>
    <tr>
      <td><a href="http://hc.apache.org/httpcomponents-client-ga/">ApacheHttpClient</a> integration for <span class="caps">HTTP</span> calls with fibers.</td>
      <td><code>co.paralleluniverse:comsat-httpclient:0.6.0</code></td>
    </tr>
    <tr>
      <td><a href="http://square.github.io/retrofit/">Retrofit</a> integration with fibers.</td>
      <td><code>co.paralleluniverse:comsat-retrofit:0.6.0</code></td>
    </tr>
    <tr>
      <td><a href="http://jdbi.org/"><span class="caps">JDBI</span></a> integration with fibers.</td>
      <td><code>co.paralleluniverse:comsat-jdbi:0.6.0</code></td>
    </tr>
    <tr>
      <td><span class="caps">JDBC</span> integration with fibers.</td>
      <td><code>co.paralleluniverse:comsat-jdbc:0.6.0</code></td>
    </tr>
    <tr>
      <td><a href="http://www.jooq.org/">j<span class="caps">OOQ</span></a> integration with fibers.</td>
      <td><code>co.paralleluniverse:comsat-jooq:0.6.0</code></td>
    </tr>
    <tr>
      <td>Mongo<span class="caps">DB</span> fiber-blocking integration for the <a href="http://www.allanbank.com/mongodb-async-driver/index.html">Allanbank <span class="caps">API</span></a>.</td>
      <td><code>co.paralleluniverse:comsat-mongodb-allanbank:0.6.0</code></td>
    </tr>
    <tr>
      <td><a href="https://github.com/square/okhttp">OkHttp</a> <span class="caps">HTTP</span>+<span class="caps">SPDY</span> client integration.</td>
      <td><code>co.paralleluniverse:comsat-okhttp:0.6.0</code></td>
    </tr>
    <tr>
      <td>The Web Actors <span class="caps">API.</span></td>
      <td><code>co.paralleluniverse:comsat-actors-api:0.6.0</code></td>
    </tr>
    <tr>
      <td>Deploy <span class="caps">HTTP</span>, <span class="caps">SSE</span> and WebSocket Web Actors as <a href="http://undertow.io/">Undertow</a> handlers.</td>
      <td><code>co.paralleluniverse:comsat-actors-undertow:0.6.0</code></td>
    </tr>
    <tr>
      <td>Deploy <span class="caps">HTTP</span>, <span class="caps">SSE</span> and WebSocket Web Actors as <a href="http://netty.io/">Netty</a> handlers.</td>
      <td><code>co.paralleluniverse:comsat-actors-netty:0.6.0</code></td>
    </tr>
    <tr>
      <td>Deploy <span class="caps">HTTP</span>, <span class="caps">SSE</span> and WebSocket Web Actors in <span class="caps">J2EE</span> 7 Servlet and WebSocket (<span class="caps">JSR</span>-356) embedded and standalone containers.</td>
      <td><code>co.paralleluniverse:comsat-actors-servlet:0.6.0</code></td>
    </tr>
    <tr>
      <td>Use Comsat in the Tomcat servlet container without java agent.</td>
      <td><code>co.paralleluniverse:comsat-tomcat-loader:0.6.0[:jdk8]</code> (for <span class="caps">JDK</span> 8 optionally add the <code>jdk8</code> classifier)</td>
    </tr>
    <tr>
      <td>Use Comsat in the Jetty servlet container without the java agent.</td>
      <td><code>co.paralleluniverse:comsat-jetty-loader:0.6.0[:jdk8]</code> (for <span class="caps">JDK</span> 8 optionally add the <code>jdk8</code> classifier)</td>
    </tr>
    <tr>
      <td><a href="http://projects.spring.io/spring-framework/">Spring Framework</a> Web integration allows using fiber-blocking controllers.</td>
      <td><code>co.paralleluniverse:comsat-spring-web:0.6.0</code></td>
    </tr>
  </tbody>
</table>

<h2 id="examples">Examples</h2>

<p>A <a href="https://github.com/puniverse/comsat-gradle-template">Gradle template</a> project and a <a href="https://github.com/puniverse/comsat-mvn-archetype">Maven archetype</a> using various integration modules and featuring setup with both Dropwizard and standalone Tomcat are available for jumpstart and study. Both have a <code>without-comsat</code> branch which is useful to clearly see the (minimal, if any) porting effort required (branches comparison works very well for this&nbsp;purporse).</p>

<p>There’s a <a href="https://github.com/puniverse/comsat-ring-template">Comsat-Ring Clojure Leiningen template</a> as well which includes an <code>auto-instrument</code> branch that doesn’t need any explicit suspendable-marking code (<code>suspendable!</code>, <code>defsfn</code>, <code>sfn</code> etc.) thanks to <a href="http://docs.paralleluniverse.co/pulsar/#automatic-instrumentation">Pulsar’s new auto-instrumentation feature</a>.</p>

<p>This GitHub project contains examples covering most of the <span class="caps">COMSAT</span> functionality: <a href="https://github.com/puniverse/comsat-examples">puniverse/comsat-examples</a>.</p>

<p>Finally there are several regularly updated third-party bootstrap projects: <a href="https://github.com/circlespainter/comsat-jooq-gradle-template">Comsat + Dropwizard + j<span class="caps">OOQ</span></a>, <a href="https://github.com/circlespainter/quasar-stocks">Comsat Web Actors Stock Quotes (ported from Akka)</a>, <a href="https://github.com/circlespainter/spring4-mvc-gradle-annotation-hello-world">Spring <span class="caps">MVC</span> + Tomcat standalone servlet container</a>.</p>

<h3 id="enabling-comsat">Enabling&nbsp;Comsat</h3>

<p>Comsat runs code in <a href="http://docs.paralleluniverse.co/quasar/">Quasar</a> fibers, which rely on bytecode instrumentation. This instrumentation is done in one of three ways: via a Java agent that must be loaded into the Servlet container; with a custom class-loader available for Tomcat and Jetty; or at compilation&nbsp;time.</p>

<p><span class="caps">AOT</span> instrumentation is an advanced topic explained in the <a href="http://docs.paralleluniverse.co/quasar/index.html#instrumentation">Quasar documentation</a>.</p>

<p>When using <span class="caps">AOT</span> instrumentation alone, all of your fiber-blocking dependencies will need to have been <span class="caps">AOT</span>-compiled already. Please note that some Comsat modules, such as <code>comast-jersey-server</code>, rely on dynamic instrumentation of third-party libraries and so they cannot be used with <span class="caps">AOT</span> instrumentation&nbsp;alone.</p>

<h4 id="the-java-agent">The Java&nbsp;Agent</h4>

<p>To use the Java agent, the following must be added to the java command line (or use your favorite build tool to add this as a <span class="caps">JVM</span> argument) when launching the&nbsp;process:</p>

<div class="highlight"><pre><code><span id="line-1">-javaagent:path-to-quasar-jar.jar
</span></code></pre></div>
<p>Java agent instrumentation works with standalone Java applications and embedded Servlet containers but at present it cannot be used with standalone Servlet&nbsp;containers.</p>

<h4 id="in-tomcat">In&nbsp;Tomcat</h4>

<p>If you’re using Tomcat as your embedded or standalone Servlet container, a custom class-loader is available for use instead of the Java Agent. You’ll need to put <code>comsat-tomcat-loader-0.6.0.jar</code> (or, for <span class="caps">JDK8</span>, <code>comsat-tomcat-loader-0.6.0-jdk8.jar</code>) into Tomcat’s <code>common/lib</code>&nbsp;directory.</p>

<p>Then, include the following in your webapp’s&nbsp;<code>META-INF/context.xml</code>:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="nt">&lt;Loader</span> <span class="na">loaderClass=</span><span class="s">&quot;co.paralleluniverse.comsat.tomcat.QuasarWebAppClassLoader&quot;</span> <span class="nt">/&gt;</span>
</span></code></pre></div>
<p>The Tomcat instrumenting class-loader has been verified to work with Tomcat <span class="caps">7.0.62</span> and Tomcat <span class="caps">8.0.23</span> standalone Servlet&nbsp;containers.</p>

<h4 id="in-jetty">In&nbsp;Jetty</h4>

<p>If you’re using Jetty as your embedded Servlet container, you have the option to use a custom class-loader instead of the Java agent. You’ll need to put <code>comsat-jetty-loader-0.6.0.jar</code> (or, for <span class="caps">JDK8</span>, <code>comsat-jetty-loader-0.6.0-jdk8.jar</code>) into Jetty’s <code>lib</code>&nbsp;directory.</p>

<p>Then, include a <code>&lt;Set name="classLoader"&gt;</code> tag in your webapp’s context&nbsp;xml:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="nt">&lt;Configure</span> <span class="na">id=</span><span class="s">&quot;ctx&quot;</span> <span class="na">class=</span><span class="s">&quot;org.eclipse.jetty.webapp.WebAppContext&quot;</span><span class="nt">&gt;</span>
</span><span id="line-2">    <span class="nt">&lt;Set</span> <span class="na">name=</span><span class="s">&quot;war&quot;</span><span class="nt">&gt;</span>./build/wars/dep.war<span class="nt">&lt;/Set&gt;</span>
</span><span id="line-3">    <span class="c">&lt;!--use custom classloader in order to instrument classes by quasar--&gt;</span>
</span><span id="line-4">    <span class="nt">&lt;Set</span> <span class="na">name=</span><span class="s">&quot;classLoader&quot;</span><span class="nt">&gt;</span>
</span><span id="line-5">        <span class="nt">&lt;New</span> <span class="na">class=</span><span class="s">&quot;co.paralleluniverse.comsat.jetty.QuasarWebAppClassLoader&quot;</span><span class="nt">&gt;</span>
</span><span id="line-6">            <span class="nt">&lt;Arg&gt;</span>
</span><span id="line-7">                <span class="nt">&lt;Ref</span> <span class="na">id=</span><span class="s">&quot;ctx&quot;</span><span class="nt">/&gt;</span>
</span><span id="line-8">            <span class="nt">&lt;/Arg&gt;</span>
</span><span id="line-9">        <span class="nt">&lt;/New&gt;</span>
</span><span id="line-10">    <span class="nt">&lt;/Set&gt;</span>
</span><span id="line-11"><span class="nt">&lt;/Configure&gt;</span>
</span></code></pre></div>
<h3 id="build">Building&nbsp;Comsat</h3>

<p>Install <a href="http://www.gradle.org">Gradle</a>, then clone the&nbsp;repository:</p>

<pre><code>git clone https://github.com/puniverse/comsat.git
</code></pre>
<p>and finally&nbsp;run:</p>

<pre><code>gradle install
</code></pre>
<p>The full testsuite can be run with&nbsp;<code>gradle build</code>.</p>

<h1 id="user-manual">User&nbsp;Manual</h1>

<h2 id="comsat-integration">Comsat&nbsp;Integration</h2>

<h3 id="servlets">Servlets</h3>

<p>Comsat supports the Servlet 3.x specification (Java <span class="caps">EE</span> 6) and enables you to write servlets that can scale to many concurrent visitors, even if servicing each requests takes a very long time, or requires calling many other services. Under the hood, Comsat does this by turning each servlet request into an asynchronous request, and then services each on a separate <a href="http://puniverse.github.io/quasar/manual/core.html#fibers">fiber</a>. Calls to other web services or to a database can be fiber- rather than thread-blocking. As a result, Comsat can serve many thousands of concurrent requests with only a handful of <span class="caps">OS</span> threads. You, on the other hand, don’t need to adopt a cumbersome asynchronous programming model. You can write the servlet code as you normally would, making synchronous (fiber-blocking) calls, provided that you use Comsat&nbsp;implementations.</p>

<p>To write a Comsat (fiber-per-request) servlet, simply extend <a href="/comsat/javadoc/co/paralleluniverse/fibers/servlet/FiberHttpServlet.html"><code>FiberHttpServlet</code></a> rather than the usual <code>javax.servlet.HttpServlet</code>, and either annotate it with <code>@WebServlet</code>, declare it in <code>web.xml</code> or use the programmatic <a href="http://docs.oracle.com/javaee/6/api/javax/servlet/ServletContainerInitializer.html">initializer <span class="caps">API</span></a>. Note how the <code>service</code> and all the <code>doXXX</code> methods are <a href="http://puniverse.github.io/quasar/manual/core.html#fibers">suspendable</a> since they’re annotated with <code>@Suspendable</code>, although they don’t declare throwing <code>SuspendExecution</code> in order to retain full servlet <span class="caps">API</span>&nbsp;compatibility.</p>

<p>You can deploy your servlet as you normally would, either as a <span class="caps">WAR</span> file (remember to enable async support for it), or in an embedded servlet&nbsp;container.</p>

<p>It is recommended that you then configure your servlet container to limit the number of threads in its thread pool to some small number, as all these threads do is create the fiber (which runs in the fiber thread pool) and&nbsp;return.</p>

<p>Example:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">FiberTestServlet</span> <span class="kd">extends</span> <span class="n">FiberHttpServlet</span> <span class="o">{</span>
</span><span id="line-2">    <span class="nd">@Override</span>
</span><span id="line-3">    <span class="nd">@Suspendable</span>
</span><span id="line-4">    <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">HttpServletResponse</span> <span class="n">resp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">ServletException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
</span><span id="line-5">        <span class="k">try</span> <span class="o">(</span><span class="n">PrintWriter</span> <span class="n">out</span> <span class="o">=</span> <span class="n">resp</span><span class="o">.</span><span class="na">getWriter</span><span class="o">())</span> <span class="o">{</span>
</span><span id="line-6">            <span class="n">Fiber</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">100</span><span class="o">);</span> <span class="c1">// &lt;== Some blocking code</span>
</span><span id="line-7">            <span class="n">out</span><span class="o">.</span><span class="na">print</span><span class="o">(</span><span class="s">&quot;testGet&quot;</span><span class="o">);</span>
</span><span id="line-8">        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="o">|</span> <span class="n">SuspendExecution</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
</span><span id="line-9">        <span class="o">}</span>
</span><span id="line-10">    <span class="o">}</span>
</span><span id="line-11"><span class="o">}</span>
</span></code></pre></div>
<p>Then you can simply add it as a regular servlet to you favorite servlet containter, e.g. for embedded&nbsp;Jetty:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="n">server</span><span class="o">.</span><span class="na">addServlet</span><span class="o">(</span><span class="s">&quot;test&quot;</span><span class="o">,</span> <span class="n">FiberTestServlet</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;/&quot;</span><span class="o">);</span>
</span></code></pre></div>
<p>To learn about writing servlets, you can refer to the <a href="http://docs.oracle.com/javaee/6/tutorial/doc/bnafd.html">Java Servlets tutorial</a>.</p>

<p>Finally some options can be configured globally via system properties or per-servlet through standard servlet configuration&nbsp;attributes:</p>

<ul>
  <li><code>co.paralleluniverse.fibers.servlet.FiberHttpServlet.asyncTimeout</code> (ms): defines the asynchronous request’s timeout (default = 120&nbsp;seconds).</li>
  <li>The following features are enabled by default and together they can add up to 8%&nbsp;overhead:
    <ul>
      <li><code>co.paralleluniverse.fibers.servlet.FiberHttpServlet.disableSyncExceptions</code>: if present or <code>true</code> as a system property or if <code>true</code> as a servlet config option it will disable the translation of exceptions to standard synchronous server exceptions via&nbsp;<code>dispatch</code>.</li>
      <li><code>co.paralleluniverse.fibers.servlet.FiberHttpServlet.disableSyncForward</code>: if present or <code>true</code> as a system property or if <code>true</code> as a servlet config option it will disable the translation of async forward requests to standard synchronous&nbsp;forwards.</li>
    </ul>
  </li>
  <li>The following workarounds are enabled by default only when running in their respective servlet container and they can add up to 3%&nbsp;overhead:
    <ul>
      <li><code>co.paralleluniverse.fibers.servlet.FiberHttpServlet.disableJettyAsyncFixes</code></li>
      <li><code>co.paralleluniverse.fibers.servlet.FiberHttpServlet.disableTomcatAsyncFixes</code></li>
    </ul>
  </li>
</ul>

<p>“Overhead” here means “percentage of execution time” and it has been measured in benchmarks with no request processing (immediate response) and <code>localhost</code> network on an Linux Ubuntu Trusty&nbsp;box.</p>

<h3 id="rest-services"><span class="caps">REST</span>&nbsp;Services</h3>

<p>You can easily create Comsat <span class="caps">REST</span> services with the <a href="https://jax-rs-spec.java.net/nonav/2.0/apidocs/index.html"><span class="caps">JAX</span>-<span class="caps">RS</span> <span class="caps">API</span></a>, the standard Java <span class="caps">REST</span> service <span class="caps">API.</span> Comsat integrates with <a href="https://jersey.java.net/">Jersey</a>, the reference <span class="caps">JAX</span>-<span class="caps">RS</span>&nbsp;implementation.</p>

<p>All you need to do in order to enjoy Comsat’s scalabilty, is replace the&nbsp;line</p>

<div class="highlight"><pre><code><span id="line-1"><span class="nt">&lt;servlet-class&gt;</span>org.glassfish.jersey.servlet.ServletContainer<span class="nt">&lt;/servlet-class&gt;</span>
</span></code></pre></div>
<p>in your <code>web.xml</code> file, which is how you would normally use Jersey in a Servlet container,&nbsp;with:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="nt">&lt;servlet-class&gt;</span>co.paralleluniverse.fibers.jersey.ServletContainer<span class="nt">&lt;/servlet-class&gt;</span>
</span><span id="line-2"><span class="nt">&lt;async-supported&gt;</span>true<span class="nt">&lt;/async-supported&gt;</span>
</span></code></pre></div>
<p>Your resource methods (the ones you annotate with <code>@GET</code>, <code>@PUT</code>, <code>@POST</code> etc.) can now be made suspendable by declaring <code>throws SuspendExecution</code>. Comsat would then run each request in a fiber. Your resource methods are free to use Comsat’s <span class="caps">JDBC</span> implementation, or Comsat’s <span class="caps">JAX</span>-<span class="caps">RS</span>&nbsp;client.</p>

<p>Here is an example of <span class="caps">REST</span> resource&nbsp;declaration:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="nd">@Singleton</span>
</span><span id="line-2"><span class="nd">@Path</span><span class="o">(</span><span class="s">&quot;/service&quot;</span><span class="o">)</span>
</span><span id="line-3"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestResource</span> <span class="o">{</span>
</span><span id="line-4">    <span class="nd">@GET</span>
</span><span id="line-5">    <span class="nd">@Produces</span><span class="o">(</span><span class="s">&quot;text/plain&quot;</span><span class="o">)</span>
</span><span id="line-6">    <span class="nd">@Suspendable</span>  <span class="c1">// &lt;------------- FIBER</span>
</span><span id="line-7">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">get</span><span class="o">(</span><span class="nd">@QueryParam</span><span class="o">(</span><span class="s">&quot;sleep&quot;</span><span class="o">)</span> <span class="kt">int</span> <span class="n">sleep</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">SuspendExecution</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span><span id="line-8">        <span class="n">Fiber</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="n">sleep</span><span class="o">);</span> <span class="c1">// &lt;--- you may use fiber blocking calls here</span>
</span><span id="line-9">        <span class="k">return</span> <span class="s">&quot;sleep was &quot;</span><span class="o">+</span><span class="n">sleep</span><span class="o">;</span>
</span><span id="line-10">    <span class="o">}</span>
</span><span id="line-11"><span class="o">}</span>
</span></code></pre></div>
<p>And then initialization of the jersey&nbsp;container:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="n">server</span><span class="o">.</span><span class="na">addServlet</span><span class="o">(</span><span class="s">&quot;api&quot;</span><span class="o">,</span> <span class="n">co</span><span class="o">.</span><span class="na">paralleluniverse</span><span class="o">.</span><span class="na">fibers</span><span class="o">.</span><span class="na">jersey</span><span class="o">.</span><span class="na">ServletContainer</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="s">&quot;/*&quot;</span><span class="o">)</span>
</span><span id="line-2">        <span class="o">.</span><span class="na">setInitParameter</span><span class="o">(</span><span class="s">&quot;jersey.config.server.provider.packages&quot;</span><span class="o">,</span> <span class="n">PACKAGE_NAME_PREFIX</span><span class="o">)</span>
</span></code></pre></div><p>To learn about writing <span class="caps">REST</span> services with <span class="caps">JAX</span>-<span class="caps">RS</span>, please refer to the <a href="https://jersey.java.net/documentation/latest/user-guide.html">Jersey User Guide</a>.</p>

<p class="alert alert-info"><strong>Note</strong>: <a href="webactors.html">Web Actors</a> are a great way to write <span class="caps">REST</span> services, as well as web-socket services, for interactive web&nbsp;applications.</p>

<h3 id="clojure-ring">Clojure&nbsp;Ring</h3>

<p>The Comsat Ring adapter is a fiber-blocking adapter based on Jetty 9: it will make your Ring handler run in a fiber rather than in a thread, boosting efficiency without requiring handler logic&nbsp;changes.</p>

<p>Comsat Ring is based on Pulsar, so it is necessary that the handler’s fiber-blocking logic and all functions calling it are declared suspendable through either the <code>sfn</code> / <code>defsfn</code> macros or the <code>suspendable!</code> call (please refer to <a href="http://docs.paralleluniverse.co/pulsar/#fibers">Pulsar docs</a> for details). This often means declaring suspendable the handler itself and middlewares applied to it. You can avoid making suspendable the resulting handler passed to the adapter though, as latter will do it for&nbsp;you.</p>

<p>So rather&nbsp;than:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="p">(</span><span class="kd">ns </span><span class="nv">myapp.core</span>
</span><span id="line-2">  <span class="p">(</span><span class="ss">:use</span> <span class="nv">ring.adapter.jetty</span><span class="p">))</span>
</span><span id="line-3">
</span><span id="line-4"><span class="p">(</span><span class="kd">defn- </span><span class="nv">hello-world</span> <span class="p">[</span><span class="nv">request</span><span class="p">]</span>
</span><span id="line-5">  <span class="p">(</span><span class="nf">Thread/sleep</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="line-6">  <span class="p">{</span><span class="ss">:status</span>  <span class="mi">200</span>
</span><span id="line-7">   <span class="ss">:headers</span> <span class="p">{</span><span class="s">&quot;Content-Type&quot;</span> <span class="s">&quot;text/plain&quot;</span><span class="p">}</span>
</span><span id="line-8">   <span class="ss">:body</span>    <span class="s">&quot;Hello World&quot;</span><span class="p">})</span>
</span><span id="line-9">
</span><span id="line-10"><span class="p">(</span><span class="kd">defn </span><span class="nv">run</span> <span class="p">[]</span> <span class="p">(</span><span class="nf">run-jetty</span> <span class="nv">hello-world</span> <span class="p">{</span><span class="ss">:port</span> <span class="mi">8080</span><span class="p">}))</span>
</span></code></pre></div>
<p>Just setup Pulsar as described in the <a href="http://docs.paralleluniverse.co/pulsar/#lein">docs</a>, remembering to add the <code>[co.paralleluniverse/comsat-ring-jetty9 "0.6.0"]</code> dependency, and change your <code>use</code> or <code>require</code> clauses&nbsp;slightly:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="p">(</span><span class="kd">ns </span><span class="nv">myapp.core</span>
</span><span id="line-2">  <span class="p">(</span><span class="ss">:use</span> <span class="nv">co.paralleluniverse.fiber.ring.jetty9</span><span class="p">)</span>
</span><span id="line-3">  <span class="p">(</span><span class="ss">:import</span> <span class="p">(</span><span class="nf">co.paralleluniverse.fibers</span> <span class="nv">Fiber</span><span class="p">))</span>
</span><span id="line-4">  <span class="p">(</span><span class="ss">:require</span> <span class="p">[</span><span class="nv">co.paralleluniverse.pulsar.core</span> <span class="ss">:as</span> <span class="nv">pc</span><span class="p">]))</span>
</span><span id="line-5">
</span><span id="line-6"><span class="p">(</span><span class="nf">pc/defsfn</span> <span class="nv">hello-world</span> <span class="p">[</span><span class="nv">request</span><span class="p">]</span>
</span><span id="line-7">  <span class="p">(</span><span class="nf">Fiber/sleep</span> <span class="mi">100</span><span class="p">)</span>
</span><span id="line-8">  <span class="p">{</span><span class="ss">:status</span>  <span class="mi">200</span>
</span><span id="line-9">   <span class="ss">:headers</span> <span class="p">{</span><span class="s">&quot;Content-Type&quot;</span> <span class="s">&quot;text/plain&quot;</span><span class="p">}</span>
</span><span id="line-10">   <span class="ss">:body</span>    <span class="s">&quot;Hello World&quot;</span><span class="p">})</span>
</span><span id="line-11">
</span><span id="line-12"><span class="p">(</span><span class="kd">defn </span><span class="nv">run</span> <span class="p">[]</span> <span class="p">(</span><span class="nf">run-jetty</span> <span class="nv">hello-world</span> <span class="p">{</span><span class="ss">:port</span> <span class="mi">8080</span><span class="p">}))</span>
</span></code></pre></div>
<p>Your handler is now running inside fibers rather than&nbsp;threads.</p>

<h3 id="clojure-http-kit-client">Clojure <span class="caps">HTTP</span> Kit&nbsp;Client</h3>

<p><a href="http://www.http-kit.org/"><span class="caps">HTTP</span> Kit</a> is a minimalist, efficient, Ring-compatible <span class="caps">HTTP</span> client/server for Clojure that supports async operation. The client <span class="caps">API</span> is an async subset of <a href="https://github.com/dakrone/clj-http">clj-http</a> and the <code>comsat-httpkit</code> integration converts it back to straightforward fiber-blocking <code>clj-http</code> through the <code>await</code> function. Being only 18 lines of code, this integration also shows how easy it is to integrate Clojure async APIs with&nbsp;Pulsar.</p>

<p>Just add <code>comsat-httpkit</code> to your dependencies and <code>require</code> the <code>co.paralleluniverse.fiber.httpkit.client</code> namespace. You can then use <code>request</code>, <code>get</code>, <code>delete</code>, <code>head</code>, <code>post</code>, <code>put</code>, <code>options</code>, <code>patch</code> inside your fibers as you would use <code>clj-http</code> (currently limited to the <code>clj-http</code> features supported by <span class="caps">HTTP</span>&nbsp;Kit):</p>

<div class="highlight"><pre><code><span id="line-1"><span class="p">(</span><span class="kd">ns </span><span class="nv">myapp</span>
</span><span id="line-2">  <span class="p">(</span><span class="ss">:require</span>
</span><span id="line-3">    <span class="p">[</span><span class="nv">co.paralleluniverse.fiber.httpkit.client</span> <span class="ss">:refer</span> <span class="ss">:all</span><span class="p">]</span>
</span><span id="line-4">    <span class="p">[</span><span class="nv">co.paralleluniverse.pulsar.core</span> <span class="ss">:refer</span> <span class="p">[</span><span class="nv">fiber</span><span class="p">]]))</span>
</span><span id="line-5">
</span><span id="line-6"><span class="p">(</span><span class="kd">defn </span><span class="nv">-main</span> <span class="p">[]</span>
</span><span id="line-7">  <span class="p">(</span><span class="nb">println </span><span class="o">@</span><span class="p">(</span><span class="nf">fiber</span> <span class="p">(</span><span class="nb">get </span><span class="s">&quot;http://google.com&quot;</span><span class="p">))))</span>
</span></code></pre></div>
<p>Have also a look at the testsuite ported from <span class="caps">HTTP</span>&nbsp;Kit.</p>

<h3 id="http-clients"><span class="caps">HTTP</span>&nbsp;Clients</h3>

<h4 id="apache-http-client">Apache Http&nbsp;Client</h4>
<p>The fiber blocking version of the Apache Http Client can be used with&nbsp;<code>FiberHttpClientBuilder</code>.
For&nbsp;example:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="kd">final</span> <span class="n">CloseableHttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">FiberHttpClientBuilder</span><span class="o">.</span>
</span><span id="line-2">        <span class="nf">create</span><span class="o">(</span><span class="mi">2</span><span class="o">).</span> <span class="c1">// use 2 io threads</span>
</span><span id="line-3">        <span class="n">setMaxConnPerRoute</span><span class="o">(</span><span class="n">concurrencyLevel</span><span class="o">).</span>
</span><span id="line-4">        <span class="n">setMaxConnTotal</span><span class="o">(</span><span class="n">concurrencyLevel</span><span class="o">).</span><span class="na">build</span><span class="o">();</span>
</span></code></pre></div>
<p>After that you can call the regular <span class="caps">API</span> from&nbsp;fibers:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="n">String</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nf">HttpGet</span><span class="o">(</span><span class="s">&quot;http://localhost:8080&quot;</span><span class="o">),</span> <span class="n">BASIC_RESPONSE_HANDLER</span><span class="o">);</span>
</span></code></pre></div>
<p>If you prefer to use the future <span class="caps">API</span> you should build a regular <code>HttpAsyncClient </code>and then wrap it with <code>FiberCloseableHttpAsyncClient.wrap</code>, for&nbsp;example</p>

<div class="highlight"><pre><code><span id="line-1"><span class="kd">final</span> <span class="n">CloseableHttpAsyncClient</span> <span class="n">client</span> <span class="o">=</span> <span class="n">FiberCloseableHttpAsyncClient</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">HttpAsyncClients</span><span class="o">.</span>
</span><span id="line-2">        <span class="nf">custom</span><span class="o">().</span>
</span><span id="line-3">        <span class="n">setMaxConnPerRoute</span><span class="o">(</span><span class="n">concurrencyLevel</span><span class="o">).</span>
</span><span id="line-4">        <span class="n">setMaxConnTotal</span><span class="o">(</span><span class="n">concurrencyLevel</span><span class="o">).</span>
</span><span id="line-5">        <span class="n">build</span><span class="o">());</span>
</span><span id="line-6"><span class="n">client</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></code></pre></div>
<p>Then you can use it as&nbsp;follows:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">HttpResponse</span><span class="o">&gt;&gt;</span> <span class="n">futures</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ArrayList</span><span class="o">&lt;&gt;();</span>
</span><span id="line-2"><span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">concurrencyLevel</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
</span><span id="line-3">    <span class="n">futures</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">client</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="k">new</span> <span class="nf">HttpGet</span><span class="o">(</span><span class="s">&quot;http://localhost:8080&quot;</span><span class="o">),</span> <span class="kc">null</span><span class="o">));</span>
</span><span id="line-4"><span class="k">for</span> <span class="o">(</span><span class="n">Future</span><span class="o">&lt;</span><span class="n">HttpResponse</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">:</span> <span class="n">futures</span><span class="o">)</span>
</span><span id="line-5">    <span class="n">assertEquals</span><span class="o">(</span><span class="s">&quot;testGet&quot;</span><span class="o">,</span> <span class="n">EntityUtils</span><span class="o">.</span><span class="na">toString</span><span class="o">(</span><span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">().</span><span class="na">getEntity</span><span class="o">()));</span>
</span></code></pre></div>
<h4 id="jersey-http-client">Jersey Http&nbsp;Client</h4>

<p>Comsat’s integrated <span class="caps">HTTP</span> client is a <span class="caps">JAX</span>-<span class="caps">RS</span> client (specifically, a Jersey client). To create a client instance compatible with Quasar fibers, use the <a href="/comsat/javadoc/co/paralleluniverse/fibers/ws/rs/client/AsyncClientBuilder.html"><code>AsyncClientBuilder</code></a>&nbsp;class:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="n">Client</span> <span class="n">client</span> <span class="o">=</span> <span class="n">AsyncClientBuilder</span><span class="o">.</span><span class="na">newClient</span><span class="o">();</span>
</span></code></pre></div>
<p>You can also pass a&nbsp;configuration:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="n">Client</span> <span class="n">client</span> <span class="o">=</span> <span class="n">AsyncClientBuilder</span><span class="o">.</span><span class="na">newClient</span><span class="o">(</span><span class="n">config</span><span class="o">);</span>
</span></code></pre></div>
<p>or use the builder&nbsp;<span class="caps">API</span>:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="kd">final</span> <span class="n">Client</span> <span class="n">client</span> <span class="o">=</span> <span class="n">AsyncClientBuilder</span><span class="o">.</span><span class="na">newBuilder</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
</span></code></pre></div>
<p>Then the usage is like the regular <span class="caps">API</span>, for&nbsp;example:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="n">String</span> <span class="n">response</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">target</span><span class="o">(</span><span class="s">&quot;http://localhost:8080&quot;</span><span class="o">).</span><span class="na">request</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></code></pre></div>
<p>To learn how to use the <span class="caps">HTTP</span> client, please refer to the <a href="https://jersey.java.net/documentation/latest/user-guide.html#client">Jersey documentation</a>, or the <a href="http://docs.oracle.com/javaee/7/api/javax/ws/rs/client/package-summary.html"><span class="caps">JAX</span>-<span class="caps">RS</span> client Javadoc</a>.</p>

<p>All of the <span class="caps">JAX</span>-<span class="caps">RS</span> <span class="caps">API</span> is supported, and blocking calls are fiber- rather than thread-blocking. If you want to execute several requests in parallel, you may use any of the “async” methods that return a&nbsp;<code>Future</code>:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="n">Future</span> <span class="n">response</span> <span class="o">=</span> <span class="n">resourceTarget</span><span class="o">.</span><span class="na">request</span><span class="o">(</span><span class="s">&quot;text/plain&quot;</span><span class="o">).</span><span class="na">header</span><span class="o">(</span><span class="s">&quot;Foo&quot;</span><span class="o">,</span> <span class="s">&quot;bar&quot;</span><span class="o">).</span><span class="na">async</span><span class="o">().</span><span class="na">get</span><span class="o">(</span><span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></code></pre></div>
<p>Calling <code>Future.get()</code> would also just block the fiber and not any <span class="caps">OS</span>&nbsp;thread.</p>

<p class="alert alert-info"><strong>Note</strong>: A method that makes use of the <span class="caps">API</span> and runs in a fiber must be declared <a href="http://puniverse.github.io/quasar/manual/core.html#fibers">suspendable</a> (normally by declaring&nbsp;<code>throws SuspendExecution</code>).</p>

<p class="alert alert-warn"><strong>Note</strong>: the Jersey client’s current implementation (since <span class="caps">2.5</span>) has a significant disadvantage w.r.t ApacheHttpClient because it uses one thread per http call. Therefore it is not recommended until this is&nbsp;fixed.</p>

<h4 id="retrofit">Retrofit</h4>

<p><a href="http://square.github.io/retrofit/"><code>Retrofit</code></a> lets you access <span class="caps">REST</span> <span class="caps">API</span> through java interface. In order to use it from fibers you should first declare a <code>Suspendable</code>&nbsp;interface:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="nd">@Suspendable</span>
</span><span id="line-2"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">interface</span> <span class="nc">MyGitHub</span> <span class="o">{</span>
</span><span id="line-3">    <span class="nd">@GET</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/repos/{owner}/{repo}/contributors&quot;</span><span class="o">)</span>
</span><span id="line-4">    <span class="n">List</span><span class="o">&lt;</span><span class="n">Contributor</span><span class="o">&gt;</span> <span class="nf">contributors</span><span class="o">(</span><span class="nd">@Path</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;owner&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">owner</span><span class="o">,</span> <span class="nd">@Path</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;repo&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">repo</span><span class="o">);</span>
</span><span id="line-5"><span class="o">}</span>
</span></code></pre></div>
<p>This interface can then be registered with <code>FiberRestAdapterBuilder</code> and then used from&nbsp;fibers:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="kd">final</span> <span class="n">MyGitHub</span> <span class="n">github</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">FiberRestAdapterBuilder</span><span class="o">().</span><span class="na">setEndpoint</span><span class="o">(</span><span class="s">&quot;http://localhost:8080&quot;</span><span class="o">).</span><span class="na">build</span><span class="o">().</span><span class="na">create</span><span class="o">(</span><span class="n">MyGitHub</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span id="line-2"><span class="c1">// ...</span>
</span><span id="line-3"><span class="c1">// usage from fiber context</span>
</span><span id="line-4"><span class="n">List</span><span class="o">&lt;</span><span class="n">Contributor</span><span class="o">&gt;</span> <span class="n">contributors</span> <span class="o">=</span> <span class="n">github</span><span class="o">.</span><span class="na">contributors</span><span class="o">(</span><span class="s">&quot;puniverse&quot;</span><span class="o">,</span> <span class="s">&quot;comsat&quot;</span><span class="o">);</span>
</span><span id="line-5"><span class="n">String</span> <span class="n">result</span> <span class="o">=</span> <span class="n">contributors</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="mi">1</span><span class="o">).</span><span class="na">login</span><span class="o">;</span>
</span></code></pre></div>
<h4 id="okhttp">OkHttp</h4>

<p>Comsat integrates with <a href="https://github.com/square/okhttp">OkHttp</a>, a modern <span class="caps">HTTP</span>+<span class="caps">SPDY</span> client and offers fiber-blocking <code>OkHttpClient</code> and <code>Call</code>&nbsp;implementation.</p>

<p>Build fiber-friendly, fully OkHttp-compatible <code>FiberOkHttpClient</code> and <code>FiberCall</code> as&nbsp;follows:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="n">Request</span> <span class="n">req</span> <span class="o">=</span> <span class="o">...;</span>
</span><span id="line-2"><span class="n">OkHttpClient</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">FiberOkHttpClient</span><span class="o">();</span>
</span><span id="line-3"><span class="n">Call</span> <span class="n">call</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="na">newCall</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>
</span></code></pre></div>
<p>OkHttp’s <code>urlconnection</code> and <code>apache</code> modules are supported as well: just pass an <code>FiberOkHttpClient</code> instance when building <code>OkUrlFactory</code> and&nbsp;<code>OkApacheClient</code>:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="n">OkUrlFactory</span> <span class="n">factory</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">OkUrlFactory</span><span class="o">(</span><span class="k">new</span> <span class="nf">FiberOkHttpClient</span><span class="o">());</span>
</span><span id="line-2"><span class="n">OkApacheClient</span> <span class="n">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">OkApacheClient</span><span class="o">(</span><span class="k">new</span> <span class="nf">FiberOkHttpClient</span><span class="o">());</span>
</span></code></pre></div>
<h3 id="db-access"><span class="caps">DB</span>&nbsp;Access</h3>

<h4 id="jdbc"><span class="caps">JDBC</span></h4>

<p>The <code>comsat-jdbc</code> project makes the <span class="caps">JDBC</span> <span class="caps">API</span> more efficient when using Quasar fibers (or fiber-backed actors). To use <span class="caps">JDBC</span> in fibers, simply wrap your database driver’s <code>DataSource</code> with <a href="/comsat/javadoc/co/paralleluniverse/fibers/jdbc/FiberDataSource.html"><code>FiberDataSource</code></a>, and use it to obtain connections. For&nbsp;example:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="kd">final</span> <span class="n">DataSource</span> <span class="n">fiberDs</span> <span class="o">=</span> <span class="n">FiberDataSource</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">ds</span><span class="o">);</span>
</span></code></pre></div>
<p>Then the DataSource can be used with the regular <span class="caps">API</span> from fibers, For&nbsp;example:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="n">Connection</span> <span class="n">conn</span> <span class="o">=</span> <span class="n">fiberDs</span><span class="o">.</span><span class="na">getConnection</span><span class="o">();</span>
</span><span id="line-2"><span class="c1">// ...</span>
</span><span id="line-3"><span class="c1">// usage in fiber context</span>
</span><span id="line-4"><span class="n">conn</span><span class="o">.</span><span class="na">setAutoCommit</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>
</span><span id="line-5"><span class="n">conn</span><span class="o">.</span><span class="na">createStatement</span><span class="o">().</span><span class="na">execute</span><span class="o">(</span><span class="s">&quot;insert into testCommit (id, name) values (1, &#39;name&#39;)&quot;</span><span class="o">);</span>
</span><span id="line-6"><span class="n">conn</span><span class="o">.</span><span class="na">commit</span><span class="o">();</span>
</span><span id="line-7"><span class="kt">boolean</span> <span class="n">notEmpty</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="na">createStatement</span><span class="o">().</span><span class="na">executeQuery</span><span class="o">(</span><span class="s">&quot;select * from testCommit&quot;</span><span class="o">).</span><span class="na">next</span><span class="o">();</span>
</span></code></pre></div>
<p class="alert alert-info"><strong>Note</strong>: A method that makes use of the <span class="caps">API</span> and runs in a fiber must be declared <a href="http://puniverse.github.io/quasar/manual/core.html#fibers">suspendable</a> (normally by declaring&nbsp;<code>throws SuspendExecution</code>).</p>

<p>Normally, Comsat transforms asynchronous (callback based) <span class="caps">API</span> into fiber-blocking operations. <span class="caps">JDBC</span>, however, has no asynchronous <span class="caps">API.</span> <code>comsat-jdbc</code> simply runs the actual thread-blocking <span class="caps">JDBC</span> operations in a thread pool, and blocks the calling fiber until the operation has completed execution in the thread pool. As a result, you will not get any scalability benefits by calling your database in fibers (unlike, say, calling web services), because an <span class="caps">OS</span> thread will still block on every <span class="caps">JDBC</span> call. In practice, though, it matters little, as your database is likely to be a narrower bottleneck than the <span class="caps">OS</span> scheduler&nbsp;anyway.</p>

<p class="alert alert-warn"><strong>Note</strong>: Your application may only may direct use of the Comsat <span class="caps">JDBC</span> data source, because methods calling the <span class="caps">API</span> must be declared suspendable (or run on regular threads). Database access frameworks (like various <span class="caps">ORM</span> solutions) that make use of <span class="caps">JDBC</span> cannot use this data source and be used in Quasar fibers. In the future, we will provide separate integration module for some popular database access&nbsp;libraries.</p>

<p>If you want to learn how to use <span class="caps">JDBC</span>, the <a href="http://docs.oracle.com/javase/tutorial/jdbc/basics/"><span class="caps">JDBC</span> tutorial</a> is a good&nbsp;resource.</p>

<h4 id="jdbc-deployment-via-jndi"><span class="caps">JDBC</span> Deployment Via&nbsp;<span class="caps">JNDI</span></h4>

<p>Servlets often make use of <span class="caps">JDBC</span> data sources exposed through <span class="caps">JNDI.</span> If you do that, you can declare a <span class="caps">COMSAT</span> (i.e. a fiber-aware) <span class="caps">JDBC</span> data source through <span class="caps">JNDI</span> that will wrap your native data source. To do so, use the <code>co.paralleluniverse.fibers.jdbc.FiberDataSourceFactory</code> DataSource factory, and pass in the number of threads you’d like <span class="caps">COMSAT</span> to use in the <span class="caps">JDBC</span> worker&nbsp;pool.</p>

<p>In order to do that first you have to include <code>comsat-jdbc-0.6.0.jar</code> in your container’s runtime classpath, by putting it into the container’s <code>lib</code>&nbsp;directory.</p>

<p>If you’re using <code>TOMCAT</code>, the following example is a snippet of <code>META-INF/context.xml</code> that will declare a DataSource under the <code>jdbc/fiberdb</code> name, which wraps a native <span class="caps">DB</span> declared under the <code>jdbc/globalds</code>&nbsp;name:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="nt">&lt;Context</span> <span class="na">path=</span><span class="s">&quot;/&quot;</span><span class="nt">&gt;</span>
</span><span id="line-2">...
</span><span id="line-3"><span class="c">&lt;!--link to the global db resource--&gt;</span>
</span><span id="line-4"><span class="nt">&lt;ResourceLink</span> <span class="na">name=</span><span class="s">&quot;jdbc/linkds&quot;</span>
</span><span id="line-5">              <span class="na">global=</span><span class="s">&quot;jdbc/globalds&quot;</span>
</span><span id="line-6">              <span class="na">type=</span><span class="s">&quot;javax.sql.DataSource&quot;</span> <span class="nt">/&gt;</span>
</span><span id="line-7"><span class="c">&lt;!--wrap the linked global db resource by fiber wrapper--&gt;</span>
</span><span id="line-8"><span class="nt">&lt;Resource</span> <span class="na">name=</span><span class="s">&quot;jdbc/fiberds&quot;</span> <span class="na">auth=</span><span class="s">&quot;Container&quot;</span> 
</span><span id="line-9">          <span class="na">type=</span><span class="s">&quot;javax.sql.DataSource&quot;</span>
</span><span id="line-10">          <span class="na">rawDataSource=</span><span class="s">&quot;jdbc/linkds&quot;</span>
</span><span id="line-11">          <span class="na">threadsCount=</span><span class="s">&quot;10&quot;</span>
</span><span id="line-12">          <span class="na">url=</span><span class="s">&quot;fiber&quot;</span>
</span><span id="line-13">          <span class="na">factory=</span><span class="s">&quot;co.paralleluniverse.fibers.jdbc.FiberDataSourceFactory&quot;</span>
</span><span id="line-14"><span class="nt">/&gt;</span>    
</span><span id="line-15"><span class="nt">&lt;/Context&gt;</span>
</span></code></pre></div>
<p>In order to do the same thing with <code>Jetty</code>, you have to include similar definition in your&nbsp;<code>WEB-INF/jetty-env.xml</code>:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="nt">&lt;Configure</span> <span class="na">id=</span><span class="s">&#39;wac&#39;</span> <span class="na">class=</span><span class="s">&quot;org.eclipse.jetty.webapp.WebAppContext&quot;</span><span class="nt">&gt;</span>
</span><span id="line-2">    <span class="c">&lt;!--jdbc linkds - create link to the global ds--&gt;</span>
</span><span id="line-3">    <span class="nt">&lt;Call</span> <span class="na">class=</span><span class="s">&quot;org.eclipse.jetty.plus.jndi.NamingEntryUtil&quot;</span> <span class="na">name=</span><span class="s">&quot;bindToENC&quot;</span><span class="nt">&gt;</span>
</span><span id="line-4">        <span class="nt">&lt;Arg&gt;&lt;/Arg&gt;</span> 
</span><span id="line-5">        <span class="nt">&lt;Arg&gt;</span>jdbc/linkds<span class="nt">&lt;/Arg&gt;</span>
</span><span id="line-6">        <span class="nt">&lt;Arg&gt;</span>jdbc/globalds<span class="nt">&lt;/Arg&gt;</span>
</span><span id="line-7">    <span class="nt">&lt;/Call&gt;</span>
</span><span id="line-8">
</span><span id="line-9">    <span class="c">&lt;!--jdbc/fiberds - create fiber wrap for the deplyed datasource--&gt;</span>
</span><span id="line-10">    <span class="nt">&lt;New</span> <span class="na">class=</span><span class="s">&quot;org.eclipse.jetty.plus.jndi.Resource&quot;</span><span class="nt">&gt;</span>
</span><span id="line-11">        <span class="nt">&lt;Arg&gt;</span>
</span><span id="line-12">            <span class="nt">&lt;Ref</span> <span class="na">id=</span><span class="s">&#39;wac&#39;</span><span class="nt">/&gt;</span>
</span><span id="line-13">        <span class="nt">&lt;/Arg&gt;</span>
</span><span id="line-14">        <span class="nt">&lt;Arg&gt;</span>jdbc/webxmlds<span class="nt">&lt;/Arg&gt;</span>
</span><span id="line-15">        <span class="nt">&lt;Arg&gt;</span>
</span><span id="line-16">            <span class="nt">&lt;Call</span> <span class="na">class=</span><span class="s">&quot;co.paralleluniverse.fibers.jdbc.FiberDataSourceFactory&quot;</span> <span class="na">name=</span><span class="s">&quot;create&quot;</span><span class="nt">&gt;</span>
</span><span id="line-17">                <span class="c">&lt;!-- jndi name of the native dataSource --&gt;</span>
</span><span id="line-18">                <span class="nt">&lt;Arg&gt;</span>jdbc/linkds<span class="nt">&lt;/Arg&gt;</span> 
</span><span id="line-19">                <span class="c">&lt;!-- number of threads in the pool --&gt;</span>
</span><span id="line-20">                <span class="nt">&lt;Arg</span> <span class="na">type=</span><span class="s">&quot;Integer&quot;</span><span class="nt">&gt;</span>10<span class="nt">&lt;/Arg&gt;</span>
</span><span id="line-21">            <span class="nt">&lt;/Call&gt;</span>
</span><span id="line-22">        <span class="nt">&lt;/Arg&gt;</span>
</span><span id="line-23">        <span class="nt">&lt;Call</span> <span class="na">name=</span><span class="s">&quot;bindToENC&quot;</span><span class="nt">&gt;</span> <span class="c">&lt;!-- spare web.xml definitions --&gt;</span>
</span><span id="line-24">            <span class="nt">&lt;Arg&gt;</span>jdbc/fiberds<span class="nt">&lt;/Arg&gt;</span> 
</span><span id="line-25">        <span class="nt">&lt;/Call&gt;</span>
</span><span id="line-26">    <span class="nt">&lt;/New&gt;</span>
</span><span id="line-27"><span class="nt">&lt;/Configure&gt;</span>
</span></code></pre></div>
<h4 id="jdbi"><span class="caps">JDBI</span></h4>

<p>To use the powerful <span class="caps">API</span> of <a href="http://jdbi.org/"><span class="caps">JDBI</span></a> to access databases you first have to create an <code>IDBI</code> instance using the <code>FiberDBI</code>&nbsp;class:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="k">this</span><span class="o">.</span><span class="na">jdbi</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">FiberDBI</span><span class="o">(</span><span class="n">ds</span><span class="o">);</span>
</span></code></pre></div>
<p>The created instance can be used both with the Fluent <span class="caps">API</span> as well as with the <code>SqlObject</code> <span class="caps">API.</span> First the fluent <span class="caps">API</span>&nbsp;example:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="k">try</span> <span class="o">(</span><span class="n">Handle</span> <span class="n">h</span> <span class="o">=</span> <span class="n">jdbi</span><span class="o">.</span><span class="na">open</span><span class="o">())</span> <span class="o">{</span>
</span><span id="line-2">    <span class="n">h</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">&quot;create table  if not exists testQueryFirst (id int primary key, name varchar(100))&quot;</span><span class="o">);</span>
</span><span id="line-3">    <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
</span><span id="line-4">        <span class="n">h</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">&quot;insert into testQueryFirst (id, name) values (?, ?)&quot;</span><span class="o">,</span> <span class="n">i</span><span class="o">,</span> <span class="s">&quot;stranger &quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
</span><span id="line-5">    <span class="n">assertEquals</span><span class="o">(</span><span class="s">&quot;stranger 37&quot;</span><span class="o">,</span> <span class="n">h</span><span class="o">.</span><span class="na">createQuery</span><span class="o">(</span><span class="s">&quot;select name from testQueryFirst where id = :id&quot;</span><span class="o">)</span>
</span><span id="line-6">            <span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="mi">37</span><span class="o">).</span><span class="na">map</span><span class="o">(</span><span class="n">StringMapper</span><span class="o">.</span><span class="na">FIRST</span><span class="o">).</span><span class="na">first</span><span class="o">());</span>
</span><span id="line-7">    <span class="n">h</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span><span class="s">&quot;drop table testQueryFirst&quot;</span><span class="o">);</span>
</span><span id="line-8"><span class="o">}</span>
</span></code></pre></div>
<p>As for the <code>SqlObject</code> <span class="caps">API</span>, declare first a <code>Suspendable</code> interface. Here is an&nbsp;example:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="nd">@Suspendable</span>
</span><span id="line-2"><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">MyDAO</span> <span class="o">{</span>
</span><span id="line-3">    <span class="nd">@SqlUpdate</span><span class="o">(</span><span class="s">&quot;create table if not exists something (id int primary key, name varchar(100))&quot;</span><span class="o">)</span>
</span><span id="line-4">    <span class="kt">void</span> <span class="nf">createSomethingTable</span><span class="o">();</span>
</span><span id="line-5">
</span><span id="line-6">    <span class="nd">@SqlUpdate</span><span class="o">(</span><span class="s">&quot;drop table something&quot;</span><span class="o">)</span>
</span><span id="line-7">    <span class="kt">void</span> <span class="nf">dropSomethingTable</span><span class="o">();</span>
</span><span id="line-8">
</span><span id="line-9">    <span class="nd">@SqlUpdate</span><span class="o">(</span><span class="s">&quot;insert into something (id, name) values (:id, :name)&quot;</span><span class="o">)</span>
</span><span id="line-10">    <span class="kt">void</span> <span class="nf">insert</span><span class="o">(</span><span class="nd">@Bind</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">)</span> <span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="nd">@Bind</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">)</span> <span class="n">String</span> <span class="n">name</span><span class="o">);</span>
</span><span id="line-11">
</span><span id="line-12">    <span class="nd">@SqlQuery</span><span class="o">(</span><span class="s">&quot;select name from something where id = :id&quot;</span><span class="o">)</span>
</span><span id="line-13">    <span class="n">String</span> <span class="nf">findNameById</span><span class="o">(</span><span class="nd">@Bind</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">)</span> <span class="kt">int</span> <span class="n">id</span><span class="o">);</span>
</span><span id="line-14"><span class="o">}</span>
</span></code></pre></div>
<p>The interface now can be registered and used as usual from&nbsp;fibers:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="k">this</span><span class="o">.</span><span class="na">dao</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">FiberDBI</span><span class="o">(</span><span class="n">dataSource</span><span class="o">).</span><span class="na">onDemand</span><span class="o">(</span><span class="n">MyDAO</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span id="line-2"><span class="c1">//...</span>
</span><span id="line-3"><span class="c1">// usage in fiber context</span>
</span><span id="line-4"><span class="n">dao</span><span class="o">.</span><span class="na">createSomethingTable</span><span class="o">();</span>
</span><span id="line-5"><span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
</span><span id="line-6">    <span class="n">dao</span><span class="o">.</span><span class="na">insert</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="s">&quot;name&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">);</span>
</span><span id="line-7"><span class="n">assertEquals</span><span class="o">(</span><span class="s">&quot;name37&quot;</span><span class="o">,</span> <span class="n">dao</span><span class="o">.</span><span class="na">findNameById</span><span class="o">(</span><span class="mi">37</span><span class="o">));</span>
</span><span id="line-8"><span class="n">dao</span><span class="o">.</span><span class="na">dropSomethingTable</span><span class="o">();</span>
</span></code></pre></div>
<h4 id="jooq">j<span class="caps">OOQ</span></h4>

<p><a href="http://www.jooq.org/"><span class="caps">JOOQ</span></a> is a comprehensive solution to access <span class="caps">SQL</span> databases. In order to use j<span class="caps">OOQ</span> from fibers, all you have to do is to provide a connection originated from <code>FiberDataSource</code>, for&nbsp;example:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="k">this</span><span class="o">.</span><span class="na">conn</span> <span class="o">=</span> <span class="n">FiberDataSource</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">dataSource</span><span class="o">).</span><span class="na">getConnection</span><span class="o">();</span>
</span><span id="line-2"><span class="k">this</span><span class="o">.</span><span class="na">ctx</span> <span class="o">=</span> <span class="n">using</span><span class="o">(</span><span class="n">conn</span><span class="o">);</span>
</span><span id="line-3"><span class="c1">// ...</span>
</span><span id="line-4"><span class="c1">// mapper definition</span>
</span><span id="line-5"><span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">Something</span> <span class="o">{</span>
</span><span id="line-6">    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">id</span><span class="o">;</span>
</span><span id="line-7">    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="n">name</span><span class="o">;</span>
</span><span id="line-8">    <span class="kd">public</span> <span class="kd">static</span> <span class="n">RecordMapper</span><span class="o">&lt;</span><span class="n">Record</span><span class="o">,</span> <span class="n">Something</span><span class="o">&gt;</span> <span class="n">mapper</span> <span class="o">=</span> <span class="k">new</span> <span class="n">RecordMapper</span><span class="o">&lt;</span><span class="n">Record</span><span class="o">,</span> <span class="n">Something</span><span class="o">&gt;()</span> <span class="o">{</span>
</span><span id="line-9">        <span class="nd">@Override</span>
</span><span id="line-10">        <span class="kd">public</span> <span class="n">Something</span> <span class="nf">map</span><span class="o">(</span><span class="n">Record</span> <span class="n">r</span><span class="o">)</span> <span class="o">{</span>
</span><span id="line-11">            <span class="k">return</span> <span class="k">new</span> <span class="nf">Something</span><span class="o">(</span><span class="n">r</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">field</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">)),</span> <span class="n">r</span><span class="o">.</span><span class="na">getValue</span><span class="o">(</span><span class="n">field</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">,</span> <span class="n">String</span><span class="o">.</span><span class="na">class</span><span class="o">)));</span>
</span><span id="line-12">        <span class="o">}</span>
</span><span id="line-13">    <span class="o">};</span>
</span><span id="line-14">
</span><span id="line-15">    <span class="kd">public</span> <span class="nf">Something</span><span class="o">(</span><span class="kt">int</span> <span class="n">id</span><span class="o">,</span> <span class="n">String</span> <span class="n">name</span><span class="o">)</span> <span class="o">{</span>
</span><span id="line-16">        <span class="k">this</span><span class="o">.</span><span class="na">id</span> <span class="o">=</span> <span class="n">id</span><span class="o">;</span>
</span><span id="line-17">        <span class="k">this</span><span class="o">.</span><span class="na">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">;</span>
</span><span id="line-18">    <span class="o">}</span>
</span><span id="line-19"><span class="o">}</span>
</span><span id="line-20"><span class="c1">// ...</span>
</span><span id="line-21"><span class="c1">// usage in fiber context</span>
</span><span id="line-22"><span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span>
</span><span id="line-23">    <span class="n">ctx</span><span class="o">.</span><span class="na">insertInto</span><span class="o">(</span><span class="n">table</span><span class="o">(</span><span class="s">&quot;something&quot;</span><span class="o">),</span> <span class="n">field</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">),</span> <span class="n">field</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">)).</span><span class="na">values</span><span class="o">(</span><span class="n">i</span><span class="o">,</span> <span class="s">&quot;name&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">).</span><span class="na">execute</span><span class="o">();</span>
</span><span id="line-24"><span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
</span><span id="line-25">    <span class="n">Something</span> <span class="n">something</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">select</span><span class="o">(</span><span class="n">field</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">),</span> <span class="n">field</span><span class="o">(</span><span class="s">&quot;name&quot;</span><span class="o">)).</span><span class="na">from</span><span class="o">(</span><span class="n">table</span><span class="o">(</span><span class="s">&quot;something&quot;</span><span class="o">)).</span><span class="na">where</span><span class="o">(</span><span class="n">field</span><span class="o">(</span><span class="s">&quot;id&quot;</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">).</span><span class="na">eq</span><span class="o">(</span><span class="n">i</span><span class="o">)).</span><span class="na">fetchOne</span><span class="o">().</span><span class="na">map</span><span class="o">(</span><span class="n">Something</span><span class="o">.</span><span class="na">mapper</span><span class="o">);</span>
</span><span id="line-26">    <span class="n">assertEquals</span><span class="o">(</span><span class="s">&quot;name&quot;</span> <span class="o">+</span> <span class="n">i</span><span class="o">,</span> <span class="n">something</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
</span><span id="line-27"><span class="o">}</span>
</span></code></pre></div>
<h4 id="mongodb">Mongo<span class="caps">DB</span></h4>

<p>Comsat integrates with Mongo<span class="caps">DB</span> and offers a fiber-blocking <a href="http://www.allanbank.com/mongodb-async-driver/index.html">allanbank <span class="caps">API</span></a>.</p>

<p>This is how you get a fiber-friendly <code>MongoDatabase</code> instance, which you can then use regularly from&nbsp;fibers:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="n">MongoClient</span> <span class="n">mongoClient</span> <span class="o">=</span> <span class="n">FiberMongoFactory</span><span class="o">.</span><span class="na">createClient</span><span class="o">(</span> <span class="s">&quot;mongodb://localhost:&quot;</span> <span class="o">+</span> <span class="n">port</span> <span class="o">+</span> <span class="s">&quot;/test?maxConnectionCount=10&quot;</span> <span class="o">).</span><span class="na">asSerializedClient</span><span class="o">();</span>
</span><span id="line-2"><span class="n">MongoDatabase</span> <span class="n">mongoDb</span> <span class="o">=</span> <span class="n">mongoClient</span><span class="o">.</span><span class="na">getDatabase</span><span class="o">(</span><span class="s">&quot;mydb&quot;</span><span class="o">);</span>
</span></code></pre></div>
<h3 id="dropwizard">Dropwizard</h3>

<p><a href="http://dropwizard.io/">Dropwizard</a> is a Java framework for developing ops-friendly, high-performance, RESTful web&nbsp;services.</p>

<p>Only few changes are needed in order to use dropwizard with&nbsp;fibers.</p>

<p>First the <span class="caps">YAML</span> configuration&nbsp;file:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="l-Scalar-Plain">server</span><span class="p-Indicator">:</span>
</span><span id="line-2">    <span class="l-Scalar-Plain">maxThreads</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">200</span>
</span><span id="line-3">    <span class="l-Scalar-Plain">minThreads</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">200</span>
</span><span id="line-4">    <span class="l-Scalar-Plain">maxQueuedRequests</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">9999</span>    
</span><span id="line-5">    <span class="l-Scalar-Plain">requestLog</span><span class="p-Indicator">:</span>
</span><span id="line-6">      <span class="l-Scalar-Plain">appenders</span><span class="p-Indicator">:</span> <span class="p-Indicator">[]</span>
</span></code></pre></div>
<p>The number of concurrent threads needed for the <code>comsat-dropwizard</code> container will be low even if the number of concurrent connection is high because threads will just hand the established connections to newly created fibers. 50 to 200 threads will be enough but you should increase the queue size. You also need to configure an adequate <code>requestLog</code> appender (or disable it). Next is the <code>httpClient</code>&nbsp;configuration:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="l-Scalar-Plain">httpClient</span><span class="p-Indicator">:</span>
</span><span id="line-2">    <span class="l-Scalar-Plain">maxConnectionsPerRoute</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">9999</span>
</span><span id="line-3">    <span class="l-Scalar-Plain">maxConnections</span><span class="p-Indicator">:</span> <span class="l-Scalar-Plain">9999</span>
</span></code></pre></div>
<p>You should also increase&nbsp;<code>maxConnections</code>.</p>

<p>The <span class="caps">DB</span> configuration will be as usual (and, as usual, you should include the <span class="caps">DB</span> driver in your runtime&nbsp;classpath):</p>

<div class="highlight"><pre><code><span id="line-1"><span class="l-Scalar-Plain">database</span><span class="p-Indicator">:</span>
</span><span id="line-2">    <span class="l-Scalar-Plain">driverClass</span><span class="p-Indicator">:</span> 
</span><span id="line-3">        <span class="l-Scalar-Plain">org.h2.Driver</span>
</span><span id="line-4">    <span class="l-Scalar-Plain">url</span><span class="p-Indicator">:</span>    
</span><span id="line-5">        <span class="l-Scalar-Plain">jdbc:h2:./build/h2testdb</span>
</span></code></pre></div>
<p>As for the&nbsp;code:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">MyDropwizardApp</span> <span class="kd">extends</span> <span class="n">FiberApplication</span><span class="o">&lt;</span><span class="n">MyConfig</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span id="line-2">    <span class="kd">private</span> <span class="n">IDBI</span> <span class="n">jdbi</span><span class="o">;</span>
</span><span id="line-3">    <span class="kd">private</span> <span class="n">MyDAO</span> <span class="n">dao</span><span class="o">;</span>
</span><span id="line-4">    <span class="kd">private</span> <span class="n">HttpClient</span> <span class="n">httpClient</span><span class="o">;</span>
</span><span id="line-5">
</span><span id="line-6">    <span class="nd">@Override</span>
</span><span id="line-7">    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">fiberRun</span><span class="o">(</span><span class="n">MyConfig</span> <span class="n">config</span><span class="o">,</span> <span class="n">Environment</span> <span class="n">env</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span id="line-8">        <span class="k">this</span><span class="o">.</span><span class="na">httpClient</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">FiberHttpClientBuilder</span><span class="o">(</span><span class="n">env</span><span class="o">).</span>
</span><span id="line-9">                <span class="n">using</span><span class="o">(</span><span class="n">config</span><span class="o">.</span><span class="na">getHttpClientConfiguration</span><span class="o">()).</span><span class="na">build</span><span class="o">(</span><span class="s">&quot;MyClient&quot;</span><span class="o">);</span>
</span><span id="line-10">        <span class="k">this</span><span class="o">.</span><span class="na">jdbi</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">FiberDBIFactory</span><span class="o">().</span><span class="na">build</span><span class="o">(</span><span class="n">env</span><span class="o">,</span> <span class="n">config</span><span class="o">.</span><span class="na">getDB</span><span class="o">(),</span> <span class="s">&quot;MyDB&quot;</span><span class="o">);</span>
</span><span id="line-11">        <span class="k">this</span><span class="o">.</span><span class="na">dao</span> <span class="o">=</span> <span class="n">jdbi</span><span class="o">.</span><span class="na">onDemand</span><span class="o">(</span><span class="n">MyDAO</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span id="line-12">        <span class="n">env</span><span class="o">.</span><span class="na">jersey</span><span class="o">().</span><span class="na">register</span><span class="o">(</span><span class="n">MY_RESOURCE_OBJ</span><span class="o">);</span>
</span><span id="line-13">    <span class="o">}</span>
</span><span id="line-14"><span class="o">}</span>
</span></code></pre></div>
<p>Instead of extending the regular <code>io.dropwizard.Application</code> class, you should extend the Comsat’s <code>FiberApplication</code>. Your regular <code>run</code> function should be named <code>fiberRun</code> instead. The creation of the <span class="caps">HTTP</span> client should be through <code>FiberHttpClientBuilder</code> and the creation of <code>jdbi</code> should be through&nbsp;<code>FiberDBIFactory</code>.</p>

<h3 id="spring">Spring</h3>

<p><a href="http://projects.spring.io/spring-framework/">Spring Framework</a> is a popular Dependency Injection engine; it integrates with many enterprise Java tools and libraries and complements them with uniform and easy-to-use&nbsp;APIs.</p>

<p><a href="http://projects.spring.io/spring-boot/">Spring Boot</a> adds fast project bootstrap facilities, convention over configuration, auto-configuration based on classpath (and other conditions) and embedded Tomcat and Jetty containers integration. It also provides <a href="http://docs.spring.io/spring-boot/docs/current/reference/htmlsingle/#production-ready">Actuator</a>, a set of ready-to-use facilities for production environments like auditing, health-checks, metrics and <span class="caps">JMX</span> monitoring/management through <span class="caps">JMX</span>’s native protocol, <span class="caps">HTTP</span>, <span class="caps">SSH</span> or&nbsp;telnet.</p>

<p><a href="http://projects.spring.io/spring-security/">Spring Security</a> is a comprehensive Java security framework encompassing authentication and authorization for traditional and web applications, and the de-facto standard for securing Spring-based&nbsp;projects.</p>

<p>Comsat provides the ability to write fiber-blocking Spring Web <span class="caps">MVC</span> controllers with (optional) Spring Boot auto-configuration and (still optional) Spring Security context inheritance for&nbsp;fibers.</p>

<h4 id="fiber-blocking-spring-web-mvc-controllers">Fiber-blocking Spring Web <span class="caps">MVC</span>&nbsp;controllers</h4>

<p>Adding support for fiber-blocking Spring Web <span class="caps">MVC</span> controllers is as easy as replacing in your Spring configuration class the <code>@EnableWebMvc</code> annotation with <code>@Import(FiberWebMvcConfigurationSupport.class)</code>, for&nbsp;example:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="nd">@Configuration</span>
</span><span id="line-2"><span class="nd">@Import</span><span class="o">(</span><span class="n">FiberWebMvcConfigurationSupport</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span id="line-3"><span class="nd">@EnableAutoConfiguration</span>
</span><span id="line-4"><span class="nd">@ComponentScan</span>
</span><span id="line-5"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">SampleTraditionalApplication</span> <span class="o">{</span>
</span><span id="line-6">    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span id="line-7">        <span class="n">SpringApplication</span><span class="o">.</span><span class="na">run</span><span class="o">(</span><span class="n">SampleTraditionalApplication</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">args</span><span class="o">);</span>
</span><span id="line-8">    <span class="o">}</span>
</span><span id="line-9"><span class="o">}</span>
</span></code></pre></div>
<p>…And declaring your controller methods as suspendable, as you would normally do with any fiber-blocking&nbsp;method:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="nd">@RequestMapping</span><span class="o">(</span><span class="n">value</span> <span class="o">=</span> <span class="s">&quot;/&quot;</span><span class="o">,</span> <span class="n">method</span> <span class="o">=</span> <span class="n">RequestMethod</span><span class="o">.</span><span class="na">GET</span><span class="o">)</span>
</span><span id="line-2"><span class="nd">@ResponseBody</span>
</span><span id="line-3"><span class="kd">public</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">String</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="nf">hello</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">SuspendExecution</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
</span><span id="line-4">    <span class="n">Fiber</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="mi">10</span><span class="o">);</span>
</span><span id="line-5">    <span class="k">return</span> <span class="n">Collections</span><span class="o">.</span><span class="na">singletonMap</span><span class="o">(</span><span class="s">&quot;message&quot;</span><span class="o">,</span>
</span><span id="line-6">            <span class="k">this</span><span class="o">.</span><span class="na">helloWorldService</span><span class="o">.</span><span class="na">getHelloMessage</span><span class="o">());</span>
</span><span id="line-7"><span class="o">}</span>
</span></code></pre></div>
<p>Spring Web <span class="caps">MVC</span> controller methods that have not been annotated (nor otherwise instrumented) to be suspendable will be invoked in thread-blocking mode rather than&nbsp;fiber-blocking.</p>

<h4 id="spring-security-support">Spring Security&nbsp;support</h4>

<p>By default, Spring Security stores the server-side security context for the current user in a Java <code>ThreadLocal</code>. For suspendable Spring Web <span class="caps">MVC</span> controllers to inherit the security context, the strategy Spring uses mut be reconfigured to use Java’s <code>InheritableThreadLocal</code> instead (please be aware that this is <span class="caps">JVM</span>-level global&nbsp;setting).</p>

<p>This is as easy as adding an <code>@Import</code> for the <code>co.paralleluniverse.springframework.security.config.FiberSecurityContextHolderConfig</code> configuration&nbsp;class:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="c1">// The following will enable fiber-blocking and will let fibers inherit security context</span>
</span><span id="line-2"><span class="nd">@FiberSecureSpringBootApplication</span>
</span></code></pre></div>
<p>At present there is one small caveat to consider when using Spring method security: as Spring will proxy secured methods so that all declared exceptions (including <code>SuspendExecution</code>) are catched individually, Quasar will refuse to instrument them. In this specific case <code>SuspendExecution</code> should not be declared but catched in the method body, and the method signature should be annotated with <code>@Suspendable</code>&nbsp;instead.</p>

<h4 id="spring-boot-auto-configuration-support">Spring Boot auto-configuration&nbsp;support</h4>

<p>If you prefer using auto-configuration, it is enough to use the <code>FiberSpringBootApplication</code> or <code>FiberSecureSpringBootApplication</code> annotation instead, depending if you want to use Spring Security and its support for&nbsp;fibers:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="nd">@FiberSpringBootApplication</span> <span class="c1">// This will enable fiber-blocking</span>
</span></code></pre></div>
<h2 id="web-actors">Web&nbsp;Actors</h2>

<p>Web Actors are <a href="http://puniverse.github.io/quasar/manual/actors.html">Quasar actors</a> that receive and respond to messages from web clients. Web actors support <span class="caps">HTTP</span>, WebSocket and <span class="caps">SSE</span> (Server-Sent Events) messages and are a convenient, efficient, and natural method to implement backends for interactive web&nbsp;applications.</p>

<p>Web Actors are deployed on a web server. Currently they can be deployed as a <a href="http://netty.io/">Netty</a> handler, as an <a href="http://undertow.io/">Undertow</a> handler as well as in any Java<span class="caps">EE</span> 7 servlet&nbsp;container.</p>

<h3 id="netty-deployment">Netty&nbsp;deployment</h3>

<p>Deploying web actors on top of Netty is as easy as inserting one of two Netty handlers in your pipeline: either <code>AutoWebActorHandler</code> or&nbsp;<code>WebActorHandler</code>.</p>

<p><code>AutoWebActorHandler</code> will automatically scan the classpath for classes with the <code>@WebActor</code> annotation upon first use and  will then instantiate and start the appropriate actor class (among detected ones) once per client session (or connection if there’s no session, see below). Its constructor requires no arguments but optionally a user-specified classloader and/or a map containing per-class actor constructor parameters can be passed&nbsp;in.</p>

<p>The only other requirement is that your channel pipeline contains separate <code>HttpRequestDecoder</code> and <code>HttpResponseEncoder</code> instances rather than a single <code>HttpServerCodec</code> because the <code>HttpResponseEncoder</code> needs to be dynamically removed when an <span class="caps">SSE</span> exchange starts. If you prefer, as an alternative you can pass to <code>AutoWebActorHandler</code>’s constructor the name of the installed&nbsp;<code>HttpResponseEncoder</code>.</p>

<p>Here’s an example server setup using <code>AutoWebActorHandler</code> without construction arguments (have a look at <code>comsat-actors-netty</code>’s tests for further&nbsp;insight):</p>

<div class="highlight"><pre><code><span id="line-1"><span class="kd">final</span> <span class="n">NioEventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
</span><span id="line-2"><span class="kd">final</span> <span class="n">NioEventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">NioEventLoopGroup</span><span class="o">();</span>
</span><span id="line-3"><span class="kd">final</span> <span class="n">ServerBootstrap</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ServerBootstrap</span><span class="o">();</span>
</span><span id="line-4"><span class="n">b</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
</span><span id="line-5">    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span id="line-6">    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nf">LoggingHandler</span><span class="o">(</span><span class="n">LogLevel</span><span class="o">.</span><span class="na">INFO</span><span class="o">))</span>
</span><span id="line-7">    <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
</span><span id="line-8">        <span class="nd">@Override</span>
</span><span id="line-9">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span id="line-10">            <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
</span><span id="line-11">            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nf">HttpRequestDecoder</span><span class="o">());</span>
</span><span id="line-12">            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nf">HttpResponseEncoder</span><span class="o">());</span>
</span><span id="line-13">            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nf">HttpObjectAggregator</span><span class="o">(</span><span class="mi">65536</span><span class="o">));</span>
</span><span id="line-14">
</span><span id="line-15">            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nf">AutoWebActorHandler</span><span class="o">());</span>
</span><span id="line-16">        <span class="o">}</span>
</span><span id="line-17">    <span class="o">});</span>
</span><span id="line-18">
</span><span id="line-19"><span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="n">INET_PORT</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
</span></code></pre></div>
<p>The way individual web actor references are assigned to individual <span class="caps">HTTP</span> exchanges is represented by the <code>WebActorHandler.Context</code> interface, which provides the web actor reference and <span class="caps">URL</span> matching&nbsp;logic.</p>

<p><code>WebActorHandler</code> delegates context lookup (or creation) to a developer-supplied <code>ContextProvider</code> which is is the only required constructor argument; here’s an example server setup using <code>WebActorHandler</code> and delegating all exchanges to a single actor (have a look at <code>comsat-actors-netty</code>’s’ tests for further&nbsp;insight):</p>

<div class="highlight"><pre><code><span id="line-1"><span class="kd">final</span> <span class="n">MyWebActor</span> <span class="n">actor</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MyWebActor</span><span class="o">();</span>
</span><span id="line-2"><span class="kd">final</span> <span class="n">MActorRef</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">WebMessage</span><span class="o">&gt;</span> <span class="n">actorRef</span> <span class="o">=</span> <span class="n">actor</span><span class="o">.</span><span class="na">spawn</span><span class="o">();</span>
</span><span id="line-3"><span class="c1">// ...</span>
</span><span id="line-4"><span class="kd">final</span> <span class="n">NioEventLoopGroup</span> <span class="n">bossGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">NioEventLoopGroup</span><span class="o">(</span><span class="mi">1</span><span class="o">);</span>
</span><span id="line-5"><span class="kd">final</span> <span class="n">NioEventLoopGroup</span> <span class="n">workerGroup</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">NioEventLoopGroup</span><span class="o">();</span>
</span><span id="line-6"><span class="kd">final</span> <span class="n">ServerBootstrap</span> <span class="n">b</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ServerBootstrap</span><span class="o">();</span>
</span><span id="line-7"><span class="n">b</span><span class="o">.</span><span class="na">group</span><span class="o">(</span><span class="n">bossGroup</span><span class="o">,</span> <span class="n">workerGroup</span><span class="o">)</span>
</span><span id="line-8">    <span class="o">.</span><span class="na">channel</span><span class="o">(</span><span class="n">NioServerSocketChannel</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
</span><span id="line-9">    <span class="o">.</span><span class="na">handler</span><span class="o">(</span><span class="k">new</span> <span class="nf">LoggingHandler</span><span class="o">(</span><span class="n">LogLevel</span><span class="o">.</span><span class="na">INFO</span><span class="o">))</span>
</span><span id="line-10">    <span class="o">.</span><span class="na">childHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">ChannelInitializer</span><span class="o">&lt;</span><span class="n">SocketChannel</span><span class="o">&gt;()</span> <span class="o">{</span>
</span><span id="line-11">        <span class="nd">@Override</span>
</span><span id="line-12">        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">initChannel</span><span class="o">(</span><span class="n">SocketChannel</span> <span class="n">ch</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">Exception</span> <span class="o">{</span>
</span><span id="line-13">            <span class="n">ChannelPipeline</span> <span class="n">pipeline</span> <span class="o">=</span> <span class="n">ch</span><span class="o">.</span><span class="na">pipeline</span><span class="o">();</span>
</span><span id="line-14">            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nf">HttpRequestDecoder</span><span class="o">());</span>
</span><span id="line-15">            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nf">HttpResponseEncoder</span><span class="o">());</span>
</span><span id="line-16">            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nf">HttpObjectAggregator</span><span class="o">(</span><span class="mi">65536</span><span class="o">));</span>
</span><span id="line-17">
</span><span id="line-18">            <span class="n">pipeline</span><span class="o">.</span><span class="na">addLast</span><span class="o">(</span><span class="k">new</span> <span class="nf">WebActorHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">WebActorHandler</span><span class="o">.</span><span class="na">ActorContextProvider</span><span class="o">()</span> <span class="o">{</span>
</span><span id="line-19">                <span class="nd">@Override</span>
</span><span id="line-20">                <span class="kd">public</span> <span class="n">WebActorHandler</span><span class="o">.</span><span class="na">ActorContext</span> <span class="nf">get</span><span class="o">(</span><span class="n">ChannelHandlerContext</span> <span class="n">ctx</span><span class="o">,</span> <span class="n">FullHttpRequest</span> <span class="n">req</span><span class="o">)</span> <span class="o">{</span>
</span><span id="line-21">                    <span class="k">return</span> <span class="k">new</span> <span class="n">WebActorHandler</span><span class="o">.</span><span class="na">DefaultActorContextImpl</span><span class="o">()</span> <span class="o">{</span>
</span><span id="line-22">                        <span class="nd">@Override</span>
</span><span id="line-23">                        <span class="kd">public</span> <span class="n">ActorRef</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">WebMessage</span><span class="o">&gt;</span> <span class="nf">getRef</span><span class="o">()</span> <span class="o">{</span>
</span><span id="line-24">                            <span class="k">return</span> <span class="n">actorRef</span><span class="o">;</span>
</span><span id="line-25">                        <span class="o">}</span>
</span><span id="line-26">                    
</span><span id="line-27">                        <span class="nd">@Override</span>
</span><span id="line-28">                        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">handlesWithWebSocket</span><span class="o">(</span><span class="n">String</span> <span class="n">uri</span><span class="o">)</span> <span class="o">{</span>
</span><span id="line-29">                            <span class="k">return</span> <span class="n">uri</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;/ws&quot;</span><span class="o">);</span>
</span><span id="line-30">                        <span class="o">}</span>
</span><span id="line-31">
</span><span id="line-32">                        <span class="nd">@Override</span>
</span><span id="line-33">                        <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">handlesWithHttp</span><span class="o">(</span><span class="n">String</span> <span class="n">uri</span><span class="o">)</span> <span class="o">{</span>
</span><span id="line-34">                            <span class="k">return</span> <span class="o">!</span><span class="n">handlesWithWebSocket</span><span class="o">(</span><span class="n">uri</span><span class="o">);</span>
</span><span id="line-35">                        <span class="o">}</span>
</span><span id="line-36">                    <span class="o">};</span>
</span><span id="line-37">                <span class="o">}</span>
</span><span id="line-38">            <span class="o">}));</span>
</span><span id="line-39">        <span class="o">}</span>
</span><span id="line-40">    <span class="o">});</span>
</span><span id="line-41">
</span><span id="line-42"><span class="kd">final</span> <span class="n">ChannelFuture</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="na">bind</span><span class="o">(</span><span class="mi">8080</span><span class="o">).</span><span class="na">sync</span><span class="o">();</span>
</span></code></pre></div>
<p><code>WebActorHandler</code> needs (and enables by default) cookie-based client session tracking only for <span class="caps">SSE</span> exchanges but it can enabled for all requests through the <code>co.paralleluniverse.comsat.webactors.netty.WebActorHandler.HttpChannelAdapter.trackSession</code> system property (legal values are <code>sse</code> and <code>always</code>). The cookie name will be <code>JSESSIONID</code> as in most server-side <span class="caps">HTTP</span> Java APIs with session support (e.g.&nbsp;servlets).</p>

<p>The Netty WebActor backend will always include the <code>Date</code> header by default but this behaviour can be configured through the <code>co.paralleluniverse.comsat.webactors.netty.WebActorHandler.HttpChannelAdapter.omitDateHeader</code> system&nbsp;property</p>

<p>Session duration for the default implementation is 10 seconds but it can be configured through the <code>co.paralleluniverse.comsat.webactors.netty.WebActorHandler.DefaultContextImpl.durationMillis</code> system&nbsp;property.</p>

<h3 id="undertow-deployment">Undertow&nbsp;deployment</h3>

<p>Deploying web actors on top of Undertow is as easy as using one of two Undertow handlers: either <code>AutoWebActorHandler</code> or&nbsp;<code>WebActorHandler</code>.</p>

<p><code>AutoWebActorHandler</code> will automatically scan the classpath for classes with the <code>@WebActor</code> annotation upon first use and will then instantiate and start the appropriate actor class (among detected ones) once per client session (or connection if there’s no session, see below). Its constructor requires no arguments but optionally a user-specified classloader and/or a map containing per-class actor constructor parameters can be&nbsp;provided.</p>

<p>Here’s an example server setup using <code>AutoWebActorHandler</code> without construction arguments (have a look at <code>comsat-actors-undertow</code>’s tests for more&nbsp;insight):</p>

<div class="highlight"><pre><code><span id="line-1"><span class="kd">final</span> <span class="n">SessionManager</span> <span class="n">sessionManager</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">InMemorySessionManager</span><span class="o">(</span><span class="s">&quot;SESSION_MANAGER&quot;</span><span class="o">,</span> <span class="mi">1</span><span class="o">,</span> <span class="kc">true</span><span class="o">);</span>
</span><span id="line-2"><span class="kd">final</span> <span class="n">SessionCookieConfig</span> <span class="n">sessionConfig</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">SessionCookieConfig</span><span class="o">();</span>
</span><span id="line-3"><span class="n">sessionConfig</span><span class="o">.</span><span class="na">setMaxAge</span><span class="o">(</span><span class="mi">60</span><span class="o">);</span>
</span><span id="line-4"><span class="kd">final</span> <span class="n">SessionAttachmentHandler</span> <span class="n">sessionAttachmentHandler</span> <span class="o">=</span>
</span><span id="line-5">    <span class="k">new</span> <span class="nf">SessionAttachmentHandler</span><span class="o">(</span><span class="n">sessionManager</span><span class="o">,</span> <span class="n">sessionConfig</span><span class="o">);</span>
</span><span id="line-6">
</span><span id="line-7"><span class="n">server</span> <span class="o">=</span> <span class="n">Undertow</span><span class="o">.</span><span class="na">builder</span><span class="o">().</span><span class="na">addHttpListener</span><span class="o">(</span><span class="n">INET_PORT</span><span class="o">,</span> <span class="s">&quot;localhost&quot;</span><span class="o">)</span>
</span><span id="line-8">     <span class="o">.</span><span class="na">setHandler</span><span class="o">(</span><span class="n">sessionAttachmentHandler</span><span class="o">.</span><span class="na">setNext</span><span class="o">(</span><span class="k">new</span> <span class="nf">AutoWebActorHandler</span><span class="o">())).</span><span class="na">build</span><span class="o">();</span>
</span><span id="line-9">
</span><span id="line-10"><span class="n">server</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></code></pre></div>
<p>Notice that the session handler is installed as well: <code>AutoWebActorHandler</code> will use Undertow sessions if available, else it will create a new actor instance for every&nbsp;exchange.</p>

<p>The way individual web actor references are assigned to individual <span class="caps">HTTP</span> exchanges is represented by the <code>WebActorHandler.Context</code> interface, which provides the web actor reference and <span class="caps">URL</span> matching&nbsp;logic.</p>

<p><code>WebActorHandler</code> delegates session lookup (or creation) to a developer-supplied <code>ContextProvider</code> which is the only required constructor argument; here’s an example server setup using <code>WebActorHandler</code> and delegating all exchanges to a single actor (have a look at <code>comsat-actors-undertow</code>’s’ tests for further&nbsp;insight):</p>

<div class="highlight"><pre><code><span id="line-1"><span class="kd">final</span> <span class="n">Actor</span> <span class="n">actor</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">MyWebActor</span><span class="o">();</span>
</span><span id="line-2"><span class="kd">final</span> <span class="n">MActorRef</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">WebMessage</span><span class="o">&gt;</span> <span class="n">actorRef</span> <span class="o">=</span> <span class="n">actor</span><span class="o">.</span><span class="na">spawn</span><span class="o">();</span>
</span><span id="line-3"><span class="c1">// ...</span>
</span><span id="line-4"><span class="n">server</span> <span class="o">=</span> <span class="n">Undertow</span><span class="o">.</span><span class="na">builder</span><span class="o">()</span>
</span><span id="line-5">    <span class="o">.</span><span class="na">addHttpListener</span><span class="o">(</span><span class="mi">8080</span><span class="o">,</span> <span class="s">&quot;localhost&quot;</span><span class="o">)</span>
</span><span id="line-6">    <span class="o">.</span><span class="na">setHandler</span><span class="o">(</span><span class="k">new</span> <span class="nf">WebActorHandler</span><span class="o">(</span><span class="k">new</span> <span class="n">WebActorHandler</span><span class="o">.</span><span class="na">ContextProvider</span><span class="o">()</span> <span class="o">{</span>
</span><span id="line-7">        <span class="nd">@Override</span>
</span><span id="line-8">        <span class="kd">public</span> <span class="n">WebActorHandler</span><span class="o">.</span><span class="na">ActorContext</span> <span class="nf">get</span><span class="o">(</span><span class="n">HttpServerExchange</span> <span class="n">xch</span><span class="o">)</span> <span class="o">{</span>
</span><span id="line-9">            <span class="k">return</span> <span class="k">new</span> <span class="n">WebActorHandler</span><span class="o">.</span><span class="na">DefaultContextImpl</span><span class="o">()</span> <span class="o">{</span>
</span><span id="line-10">                <span class="nd">@Override</span>
</span><span id="line-11">                <span class="kd">public</span> <span class="n">ActorRef</span><span class="o">&lt;?</span> <span class="kd">extends</span> <span class="n">WebMessage</span><span class="o">&gt;</span> <span class="nf">getRef</span><span class="o">()</span> <span class="o">{</span>
</span><span id="line-12">                    <span class="k">return</span> <span class="n">actorRef</span><span class="o">;</span>
</span><span id="line-13">                <span class="o">}</span>
</span><span id="line-14">
</span><span id="line-15">                <span class="nd">@Override</span>
</span><span id="line-16">                <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">handlesWithWebSocket</span><span class="o">(</span><span class="n">String</span> <span class="n">uri</span><span class="o">)</span> <span class="o">{</span>
</span><span id="line-17">                   <span class="k">return</span> <span class="n">uri</span><span class="o">.</span><span class="na">startsWith</span><span class="o">(</span><span class="s">&quot;/ws&quot;</span><span class="o">);</span>
</span><span id="line-18">                <span class="o">}</span>
</span><span id="line-19">
</span><span id="line-20">                <span class="nd">@Override</span>
</span><span id="line-21">                <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">handlesWithHttp</span><span class="o">(</span><span class="n">String</span> <span class="n">uri</span><span class="o">)</span> <span class="o">{</span>
</span><span id="line-22">                    <span class="k">return</span> <span class="o">!</span><span class="n">handlesWithWebSocket</span><span class="o">(</span><span class="n">uri</span><span class="o">);</span>
</span><span id="line-23">                <span class="o">}</span>
</span><span id="line-24">            <span class="o">};</span>
</span><span id="line-25">        <span class="o">}</span>
</span><span id="line-26">    <span class="o">})).</span><span class="na">build</span><span class="o">();</span>
</span><span id="line-27">
</span><span id="line-28"><span class="n">server</span><span class="o">.</span><span class="na">start</span><span class="o">();</span>
</span></code></pre></div>
<p>If not using Undertow sessions please consider that <code>WebActorHandler</code> assumes the same actor will manage a whole <span class="caps">SSE</span>&nbsp;session.</p>

<p>The actor context validity is 10 seconds by default but it can be configured through the <code>co.paralleluniverse.comsat.webactors.undertow.WebActorHandler.DefaultContextImpl.durationMillis</code> system&nbsp;property.</p>

<h3 id="servlet-deployment">Servlet&nbsp;deployment</h3>

<p>A web actor is attached to a servlet web session. It can be spawned and attached manually (say, after the user logs in and the session is authenticated). The manual attachment <span class="caps">API</span> unfortunately is container dependent. A web actor can also be spawned and attached automatically by letting <span class="caps">COMSAT</span> spawn and attach a web actor to every newly created session and this method will be described below. Because a web actor consumes very few resources, spawning them automatically is sufficient in all but the most extreme&nbsp;circumstances.</p>

<p>For automatic deployment, all you have to do is define an actor class (one that extends <code>BasicActor</code> or <code>Actor</code>), and annotate it with the <a href="/comsat/javadoc/co/paralleluniversecomsat/webactors/WebActor.html"><code>WebActor</code></a> annotation. For&nbsp;example:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="nd">@WebActor</span><span class="o">(</span><span class="n">name</span><span class="o">=</span><span class="s">&quot;chat&quot;</span><span class="o">,</span> <span class="n">httpUrlPatterns</span><span class="o">=</span><span class="s">&quot;/chat&quot;</span><span class="o">,</span> <span class="n">webSocketUrlPatterns</span><span class="o">=</span><span class="s">&quot;/chat/ws&quot;</span><span class="o">)</span>
</span><span id="line-2"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ChatActor</span> <span class="kd">extends</span> <span class="n">BasicActor</span><span class="o">&lt;</span><span class="n">WebMessage</span><span class="o">,</span> <span class="n">Void</span><span class="o">&gt;</span> <span class="o">{</span>
</span><span id="line-3">    <span class="nd">@Override</span>
</span><span id="line-4">    <span class="kd">protected</span> <span class="n">Void</span> <span class="nf">doRun</span><span class="o">()</span> <span class="o">{</span>
</span><span id="line-5">        <span class="c1">// ...</span>
</span><span id="line-6">    <span class="o">}</span>
</span><span id="line-7"><span class="o">}</span>
</span></code></pre></div>
<p>In this example, all <span class="caps">HTTP</span> requests to the <code>/chat</code> resource, as well as all websocket messages to <code>/chat/ws</code> will be received as messages by the actor. A new <code>ChatActor</code> will be spawned for every new <span class="caps">HTTP</span>&nbsp;session.</p>

<h4 id="embedded-containers">Embedded&nbsp;containers</h4>

<p>If you use embedded container, you have to register <code>WebActorInitializer</code> as a <code>ServletContextListener</code> to your servlet container. It will scan and register the web actors according to the <code>@WebActor</code>&nbsp;annotation:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="n">WebActorInitializer</span><span class="o">.</span><span class="na">setUserClassLoader</span><span class="o">(</span><span class="n">ClassLoader</span><span class="o">.</span><span class="na">getSystemClassLoader</span><span class="o">());</span>
</span><span id="line-2"><span class="n">embeddedServer</span><span class="o">.</span><span class="na">addServletContextListener</span><span class="o">(</span><span class="n">WebActorInitializer</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span></code></pre></div>
<p>Web actors may use websockets. In order to do that the container has to be configured to support it and unfortunately there’s no standard mechanism for that yet. With Jetty you have to include the <code>javax-websocket-server-impl</code> jar and call the following method before you start the&nbsp;container:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="n">WebSocketServerContainerInitializer</span><span class="o">.</span><span class="na">configureContext</span><span class="o">(</span><span class="n">context</span><span class="o">);</span>
</span></code></pre></div>
<p>With Tomcat you have to include the <code>tomcat-embed-websocket</code> jar and register&nbsp;<code>ServletContainerInitilizer</code>:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="n">context</span><span class="o">.</span><span class="na">addServletContainerInitializer</span><span class="o">(</span><span class="k">new</span> <span class="nf">WsSci</span><span class="o">(),</span> <span class="kc">null</span><span class="o">);</span>
</span></code></pre></div>
<p>With Undertow you’ll need the <code>undertow-websockets-jsr</code> jar; the setup is then a bit more involved as Undertow’s <code>ServerWebSocketContainer</code> requires several construction&nbsp;arguments.</p>

<p>You can find an example for each of the servers above in the <code>comsat-test-utils</code> project <a href="https://github.com/puniverse/comsat/tree/master/comsat-test-utils/src/main/java/co/paralleluniverse/embedded/containers">here</a>: each embedded server utility class has an <code>enableWebsockets</code> method that performs the websockets&nbsp;setup.</p>

<p>For further details about the Web Actors <span class="caps">API</span> see the <a href="/comsat/javadoc/co/paralleluniverse/comsat/webactors/WebActor.html">Javadoc</a>.</p>

<h3 id="basic-operation">Basic&nbsp;Operation</h3>

<p>A web actor will receive messages of type <a href="/comsat/javadoc/co/paralleluniverse/comsat/webactors/WebMessage.html"><code>WebMessage</code></a>, which is the supertype of all messages that can be received from or sent to a web client. The class encapsulates a message body which can be either text or binary, and a <em>sender</em>, which, following a common actor pattern, is the actor that sent the&nbsp;message.</p>

<p>For messages received from the web client, the <em>sender</em> is a virtual actor representing the web client. You can perform normal actor operations on it, like <code>watch</code> to detect actor death; their semantics depend on the specific type of the&nbsp;message.</p>

<p>A single web actor instance may handle <span class="caps">HTTP</span> requests, emit <span class="caps">SSE</span> events, and handle one or more WebSocket&nbsp;connections.</p>

<h3 id="http-rest-services"><span class="caps">HTTP</span> (<span class="caps">REST</span>&nbsp;Services)</h3>

<p>A web actor is attached to one or more <span class="caps">HTTP</span> resources (as specified by <code>@WebActor</code>’s <code>httpUrlPatterns</code> property), and an actor instance is associated with a single <span class="caps">HTTP</span> session. Every <span class="caps">HTTP</span> request to the resource, associated with the session, will be received by the actor as an <a href="/comsat/javadoc/co/paralleluniverse/comsat/webactors/HttpRequest.html"><code>HttpRequest</code></a> message. The actor can then respond with an <a href="/comsat/javadoc/co/paralleluniverse/comsat/webactors/HttpResponse.html"><code>HttpResponse</code></a> message, which it sends to the request’s&nbsp;sender.</p>

<p>All <span class="caps">HTTP</span> request messages to a specific web actor instance will come from the same sender. If you <code>watch</code> that sender actor, it will emit an <code>ExitMessage</code> (signifying its death), when the session is&nbsp;terminated.</p>

<p>When you respond to an <code>HttpRequest</code> with an <code>HttpResponse</code>, by default, the request stream will close. If, however, you wish to send the response’s body in parts (e.g., for <span class="caps">SSE</span>, discussed in the next section), you may call <code>HttpRequest.openChannel</code>, which will return a Quasar <em>channel</em> that can be used to send <a href="/comsat/javadoc/co/paralleluniversecomsat/webactors/WebDataMessage.html"><code>WebDataMessage</code></a>s messages to the stream. The stream will flush after each <code>WebDataMessage</code>’s body has been written to it. If <code>openChannel</code> has been called, the <span class="caps">HTTP</span> response stream will be closed when <code>close</code> is called on the returned&nbsp;channel.</p>

<p>Please refer to the <a href="/comsat/javadoc/co/paralleluniverse/comsat/webactors/HttpRequest.html">Javadoc</a> for&nbsp;details.</p>

<h3 id="sse"><span class="caps">SSE</span></h3>

<p><span class="caps">SSE</span>, or <a href="http://dev.w3.org/html5/eventsource/">Server-Sent Events</a>, is an <span class="caps">HTML5</span> standard, supported by most modern browsers, for pushing discrete messages to the web client, without it sending new <span class="caps">HTTP</span> requests for each one. A good tutorial by Eric Bidelman on <span class="caps">SSE</span> can be found <a href="http://www.html5rocks.com/en/tutorials/eventsource/basics/">here</a>. An <span class="caps">SSE</span> stream is initiated with an <span class="caps">HTTP</span> request; then, each event message is written to the response stream and flushed, only the messages need to be encoded according to the <span class="caps">SSE</span> standard. <span class="caps">SSE</span> also specifies that if the connection is closed, the client will attempt to reconnect with a new request after a timeout, that can be set by the&nbsp;server.</p>

<p>The <a href="/comsat/javadoc/co/paralleluniverse/comsat/webactors/SSE.html"><code>SSE</code></a> class contains a set of static utility methods that encode the events according to the <span class="caps">SSE</span> standard, and ensure that the response headers are set correctly (in terms of character encoding,&nbsp;etc.).</p>

<p>To start an <span class="caps">SSE</span> stream in response to an <code>HttpRequest</code>, do the&nbsp;following:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="n">request</span><span class="o">.</span><span class="na">getFrom</span><span class="o">().</span><span class="na">send</span><span class="o">(</span><span class="k">new</span> <span class="nf">HttpResponse</span><span class="o">(</span><span class="n">self</span><span class="o">(),</span> <span class="n">SSE</span><span class="o">.</span><span class="na">startSSE</span><span class="o">(</span><span class="n">request</span><span class="o">)));</span>
</span></code></pre></div>
<p>This will set <code>HttpResponse</code>’s <code>startActor</code> flag, which will leave the response stream open and send back an <a href="/comsat/javadoc/co/paralleluniverse/comsat/webactors/HttpStreamOpened.html"><code>HttpStreamOpened</code></a> message from a newly created actor representing the <span class="caps">SSE</span> stream. Once you receive the message, you send <span class="caps">SSE</span> events by sending <code>WebDataMessage</code>s to that&nbsp;actor:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="n">sseActor</span><span class="o">.</span><span class="na">send</span><span class="o">(</span><span class="k">new</span> <span class="nf">WebDataMessage</span><span class="o">(</span><span class="n">self</span><span class="o">(),</span> <span class="n">SSE</span><span class="o">.</span><span class="na">event</span><span class="o">(</span><span class="s">&quot;this is an SSE event!&quot;</span><span class="o">)));</span>
</span></code></pre></div>
<p>To close the stream, you send a <code>co.paralleluniverse.actors.ShutdownMessage</code> to the <span class="caps">SSE</span> actor like&nbsp;so:</p>

<div class="highlight"><pre><code><span id="line-1"><span class="n">co</span><span class="o">.</span><span class="na">paralleluniverse</span><span class="o">.</span><span class="na">actors</span><span class="o">.</span><span class="na">ActorUtil</span><span class="o">.</span><span class="na">sendOrInterrupt</span><span class="o">(</span><span class="n">sseActor</span><span class="o">,</span> <span class="k">new</span> <span class="nf">ShutdownMessage</span><span class="o">());</span>
</span></code></pre></div>
<p>It might be convient (and elegant) to wrap the channel returned by <code>openStream</code> with a <em>mapping channel</em> (see the Quasar docs) that will transform a message class representing the event into an <span class="caps">SSE</span>-encoded&nbsp;<code>WebDataMessage</code>.</p>

<h3 id="websockets">WebSockets</h3>

<p><a href="http://en.wikipedia.org/wiki/WebSocket">WebSocket</a> is a new web protocol for low(ish)-latency, bi-directional communication between the client and the server. Web sockets are extremely useful for interactive web applications, and they fit beautifully with <span class="caps">COMSAT</span> Web&nbsp;Actors.</p>

<p>A web actor may register itself to handle web socket connections by declaring which WebSocket URIs it is interesten in, in the <code>@WebActor</code> annotations <code>webSocketUrlPatterns</code> property. Such a web actor will handle all web socket sessions at those URIs associated with the actor instance’s <span class="caps">HTTP</span> session (a web socket is also associated with an <span class="caps">HTTP</span>&nbsp;session).</p>

<p>When the client connects to a web socket, the web actor will receive a <a href="/comsat/javadoc/co/paralleluniverse/comsat/webactors/WebSocketOpened.html"><code>WebSocketOpened</code></a> message, and each following message will be received as a <a href="/comsat/javadoc/co/paralleluniversecomsat/webactors/WebDataMessage.html"><code>WebDataMessage</code></a>. The actor can send messages to the client by replying to the sender with <code>WebDataMessage</code>s of its&nbsp;own.</p>

<p>The virtual actor that’s the <em>sender</em> of the messages received from the client represents the WebSocket session; i.e., each open web socket will have a different actor as the sender of the messages. That virtual actor dies when the web socket connection&nbsp;closes.</p>

					</div>
				</div><!--main-->
			</div><!--docs-cont-->
		</div> <!--container-->
	</section><!--main-->

	<!-- <top-nav> -->
<div id="doumentation-bottom-bar">
	<div class="container">
		<div class="side-title"><h2>documentation</h2></div>
		<h3>Comsat</h3>
		<a href="https://github.com/puniverse/comsat" class="btn-1"><span>View on Github</span></a>
		<a href="/comsat/javadoc/index.html" class="btn-2"><span>API</span></a>
		<a href="https://github.com/puniverse/comsat/issues/new" class="btn-3"><span>File a bug</span></a>
		<a href="https://groups.google.com/forum/#!forum/comsat-user" class="btn-4"><span>Discuss</span></a>
	</div>
</div>
<!-- </top-nav> -->


	<footer>
        <div class="container">
            <div id="logo-footer"></div>
            <ul>
                <li><a href="http://paralleluniverse.co/support/">Support</a></li>
                <li><a href="http://docs.paralleluniverse.co">Documentation</a></li>
                <li><a href="http://paralleluniverse.co/about/">Company</a></li>
                <li><a href="http://blog.paralleluniverse.co">Blog</a></li>
            </ul>
            <a href="https://www.facebook.com/puniverseco" class="social social1">social</a>
            <a href="https://twitter.com/puniverseco" class="social social2">social</a>
            <a href="http://www.linkedin.com/company/parallel-universe?trk=company_name" class="social social3">social</a>
        </div><!--container-->
</footer>

</body>
</html>
