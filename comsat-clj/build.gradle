import groovy.io.FileType;

def execOnLeinSubs(String... leinCmds) {
  new File('.').eachFile(FileType.DIRECTORIES) {
    def dir = it
    dir.eachFileMatch(FileType.FILES, ~/lein/) {
      def proc = new ProcessBuilder(*(['./lein', *leinCmds])).directory(dir).redirectErrorStream(true).start()
      proc.in.eachLine {line -> println line}
      proc.waitFor()
      if (proc.exitValue()) throw new GradleScriptException("")
    }
  }
}

task compileLein << {
  execOnLeinSubs('sub', 'compile')
}

task testLein << {
  execOnLeinSubs('sub', 'test')
}

task docsLein << {
  execOnLeinSubs('sub', 'doc')
  execOnLeinSubs('sub', 'marg')
  execOnLeinSubs('sub', 'html5-docs')
}

task cleanLein << {
  execOnLeinSubs('sub', 'clean')
}

compileJava.dependsOn(compileLein)
compileTestJava.dependsOn(compileLein)

test.dependsOn(testLein)

javadoc.dependsOn(docsLein)

clean.dependsOn(cleanLein)
